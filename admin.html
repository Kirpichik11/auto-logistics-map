<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–¥–º–∏–Ω–∫–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display:grid; grid-template-columns: 1fr 430px; height:100vh; }
    #map { height:100vh; }
    .side { border-left:1px solid #eee; padding:12px; overflow:auto; background:#fff; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px; }
    label { display:block; font-size:12px; color:#666; margin:8px 0 4px; }
    input, select { width:100%; padding:9px; border:1px solid #ddd; border-radius:10px; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .small { font-size:12px; color:#666; }
    .ok { color:#0a7; }
    .err { color:#d33; }
    .tabs { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .tab { padding:8px 10px; border:1px solid #ddd; border-radius:999px; cursor:pointer; }
    .tab.active { background:#f3f3f3; }
    .listItem { border-top:1px dashed #eee; padding:8px 0; }
    .pill { display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#f6f6f6; margin-left:6px; }
    .muted { color:#888; }

    .carIcon { font-size:18px; transform: translate(-6px,-10px); filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25)); user-select:none; }
    .hubIcon {
      font-size:18px;
      width:28px; height:28px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:#e0e0e0;
      border:2px solid #555;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
      user-select:none;
    }
    .hubIcon.active { background:#333; border-color:#000; color:#fff; }

    .routeRow{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid rgba(0,0,0,0.1);
      border-radius:10px; margin:6px 0;
    }
    .routeRowTitle{ flex:1; font-size:12px; }

    .sep { border:none;border-top:1px dashed #eee;margin:12px 0; }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map"></div>

  <div class="side">
    <div class="card">
      <b>–î–æ—Å—Ç—É–ø</b>
      <div class="small">–í–≤–µ–¥–∏—Ç–µ ADMIN_PASS (–æ–¥–∏–Ω –æ–±—â–∏–π –ø–∞—Ä–æ–ª—å).</div>
      <label>–ü–∞—Ä–æ–ª—å</label>
      <input id="adminKey" type="password" placeholder="ADMIN_PASS" />
      <button onclick="saveKey()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div id="authMsg" class="small"></div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabHubs" onclick="showTab('hubs')">–•–∞–±—ã</div>
      <div class="tab" id="tabCars" onclick="showTab('cars')">–ê–≤—Ç–æ</div>
    </div>

    <!-- HUBS -->
    <div id="panelHubs" class="card">
      <b>–•–∞–±—ã</b>
      <div class="small">–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Üí –∑–∞–ø–æ–ª–Ω–∏—Ç—å ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ö–ª–∏–∫ –ø–æ —Ö–∞–±—É –Ω–∞ –∫–∞—Ä—Ç–µ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.</div>

      <input id="hubId" type="hidden" />

      <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label>
      <div class="row">
        <input id="hubLat" placeholder="lat" />
        <input id="hubLng" placeholder="lng" />
      </div>

      <label>–°—Ç—Ä–∞–Ω–∞</label>
      <select id="hubCountry">
        <option value="CN">–ö–∏—Ç–∞–π</option>
        <option value="RU">–†–æ—Å—Å–∏—è</option>
      </select>

      <label>–ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä HEIHE)</label>
      <input id="hubCode" placeholder="CODE" />

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å)</label>
      <input id="hubNameRu" placeholder="–•—ç–π—Ö—ç (Heihe)" />

      <label>–¢–∏–ø –ø—É–Ω–∫—Ç–∞</label>
      <select id="hubType">
        <option value="hub">üè≠ –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ö–∞–±</option>
        <option value="border">üöß –ì—Ä–∞–Ω–∏—Ü–∞</option>
        <option value="office">üè¢ –ù–∞—à –æ—Ñ–∏—Å</option>
        <option value="service">üè™ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ / –°–µ—Ä–≤–∏—Å-–ø–∞—Ä—Ç–Ω—ë—Ä</option>
      </select>

      <label>–°—Ä–æ–∫ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ö–∞–±–∞ (—Å—É—Ç–∫–∏)</label>
      <input id="hubDwell" placeholder="0.5" />

      <div class="row">
        <button onclick="saveHub()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="resetHubForm()">–ù–æ–≤—ã–π</button>
      </div>

      <div id="hubMsg" class="small"></div>

      <hr class="sep">
      <button onclick="loadAll()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      <div id="hubsList" class="small"></div>

      <hr class="sep">

      <!-- BORDER PAIRS (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω–∫–µ) -->
      <b>–ü–∞—Ä—ã –≥—Ä–∞–Ω–∏—Ü—ã</b>
      <div class="small">–°–≤—è–∑–∫–∞ CN-–ø—É–Ω–∫—Ç–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∏ RU-–ø—É–Ω–∫—Ç–∞ –≥—Ä–∞–Ω–∏—Ü—ã. –î–ª—è land –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –∫–æ—Ä–∏–¥–æ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏ (CN) ‚Äî –æ–Ω–∏ –ø–æ–ø–∞–¥—É—Ç –≤ –º–∞—Ä—à—Ä—É—Ç.</div>

      <input id="pairId" type="hidden" />

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—ã</label>
      <input id="pairName" placeholder="–•—ç–π—Ö—ç ‚Üí –ë–ª–∞–≥–æ–≤–µ—â–µ–Ω—Å–∫" />

      <label>–†–µ–∂–∏–º</label>
      <select id="pairMode">
        <option value="land">–°—É—Ö–æ–ø—É—Ç–Ω—ã–π (land)</option>
        <option value="sea">–ú–æ—Ä—Å–∫–æ–π (sea)</option>
      </select>

      <label>CN –ø—É–Ω–∫—Ç –≥—Ä–∞–Ω–∏—Ü—ã</label>
      <select id="pairCnHub"></select>

      <label>RU –ø—É–Ω–∫—Ç –≥—Ä–∞–Ω–∏—Ü—ã</label>
      <select id="pairRuHub"></select>

      <label>CN –∫–æ—Ä–∏–¥–æ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <div class="small muted">–í—ã–±–µ—Ä–∏—Ç–µ 0..N —Ç–æ—á–µ–∫ –≤ –ö–∏—Ç–∞–µ. –û–Ω–∏ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –º–µ–∂–¥—É —Å—Ç–∞—Ä—Ç–æ–º –∏ CN-–≥—Ä–∞–Ω–∏—Ü–µ–π (–¥–ª—è land).</div>
      <select id="pairWaypoints" multiple size="6"></select>

      <label>–ê–∫—Ç–∏–≤–Ω–∞</label>
      <select id="pairActive">
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
      </select>

      <div class="row" style="margin-top:8px">
        <button onclick="savePair()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä—É</button>
        <button onclick="resetPairForm()">–ù–æ–≤–∞—è</button>
      </div>

      <div id="pairMsg" class="small"></div>
      <div id="pairsList" class="small" style="margin-top:8px"></div>
    </div>

    <!-- CARS -->
    <div id="panelCars" class="card" style="display:none">
      <b>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</b>
      <div class="small">–°–æ–∑–¥–∞–Ω–∏–µ + —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ú–∞—Ä—à—Ä—É—Ç –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –∑–∞—Ç–µ–º –≤—Ä—É—á–Ω—É—é –ø—Ä–∞–≤–∏—Ç—å.</div>

      <input id="carId" type="hidden" />

      <label>VIN (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∫–∞)</label>
      <input id="carVin" placeholder="VIN" />

      <label>‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∫–∞)</label>
      <input id="carContract" placeholder="‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞" />

      <label>–ú–∞—Ä–∫–∞</label>
      <input id="carBrand" placeholder="Toyota" />

      <label>–ú–æ–¥–µ–ª—å</label>
      <input id="carModel" placeholder="RAV4" />

      <label>–§–æ—Ç–æ (URL)</label>
      <input id="carPhoto" placeholder="https://..." />

      <label>–°—Ä–æ—á–Ω–æ—Å—Ç—å</label>
      <select id="carUrgency">
        <option value="std">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
        <option value="fast">–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è</option>
      </select>

      <label>–°—Ç–∞—Ä—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ (–¥–∞—Ç–∞/–≤—Ä–µ–º—è)</label>
      <input id="carStartTime" type="datetime-local" />

      <hr class="sep">

      <b>–ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞</b>
      <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—Ç (CN), –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É (RU) –∏ –ø–∞—Ä—É –≥—Ä–∞–Ω–∏—Ü—ã. –ú–æ—Ä—Å–∫–∏–µ –ø–∞—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã –∏—Ö –≤—ã–±—Ä–∞–ª–∏ –≤—Ä—É—á–Ω—É—é.</div>

      <label>–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ (–ö–∏—Ç–∞–π)</label>
      <select id="carStartCN"></select>

      <label>–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ (–†–æ—Å—Å–∏—è)</label>
      <select id="carEndRU"></select>

      <label>–ü–∞—Ä–∞ –≥—Ä–∞–Ω–∏—Ü—ã (CN ‚Üí RU)</label>
      <select id="carBorderPair"></select>

      <div class="row" style="margin-top:8px">
        <button type="button" onclick="autoBuildRoute()">–°–æ–±—Ä–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</button>
        <button type="button" onclick="clearRouteEditor()">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
      </div>

      <hr class="sep">

      <b>–ú–∞—Ä—à—Ä—É—Ç (—Ä—É—á–Ω–∞—è –ø—Ä–∞–≤–∫–∞)</b>
      <div class="small">–î–æ–±–∞–≤–ª—è–π—Ç–µ/—É–¥–∞–ª—è–π—Ç–µ/–¥–≤–∏–≥–∞–π—Ç–µ —Ç–æ—á–∫–∏ ‚Äî —ç—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ route_hub_ids.</div>

      <div class="row" style="margin-top:8px">
        <select id="routeAddHubSelect"></select>
        <button type="button" id="routeAddBtn">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
      </div>

      <div id="routeList" style="margin-top:10px"></div>

      <label>–ü–æ–∫–∞–∑ –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–π –∫–∞—Ä—Ç–µ</label>
      <select id="carPublic">
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
      </select>

      <div class="row">
        <button onclick="saveCar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="resetCarForm()">–ù–æ–≤—ã–π</button>
      </div>

      <div id="carMsg" class="small"></div>

      <hr class="sep">
      <b>–ü–æ–∏—Å–∫</b>
      <label>VIN –∏–ª–∏ –¥–æ–≥–æ–≤–æ—Ä</label>
      <div class="row">
        <input id="carSearch" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä JTM..." />
        <button onclick="searchCars()">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="carsList" class="small"></div>
    </div>

  </div>
</div>

<script>
/* ================= MAP ================= */
const map = L.map('map').setView([50.5, 127.5], 4);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19,
  attribution: ''
}).addTo(map);

const hubLayer = L.layerGroup().addTo(map);
const carLayer = L.layerGroup().addTo(map);

let adminKey = localStorage.getItem("adminKey") || "";
document.getElementById("adminKey").value = adminKey;

let hubs = [];
let carsCache = [];
let hubMarkersById = new Map();
let carMarkersById = new Map();
let hubsById = new Map();
let allHubs = [];

const ACTIVE_HUB_RADIUS_KM = 10;

// border pairs from DB
let borderPairs = [];

// route editor
let editingRouteHubIds = [];

function hubTypeLabel(t){
  if (t === "border") return "–ì—Ä–∞–Ω–∏—Ü–∞";
  if (t === "office") return "–û—Ñ–∏—Å";
  if (t === "service") return "–°–µ—Ä–≤–∏—Å/–í—ã–¥–∞—á–∞";
  return "–•–∞–±";
}

function hubEmoji(type) {
  if (type === "border") return "üöß";
  if (type === "office") return "üè¢";
  if (type === "service") return "üè™";
  return "üè≠";
}

function makeHubIcon(hub, active) {
  const emoji = hubEmoji(hub.type);
  const cls = active ? "hubIcon active" : "hubIcon";
  return L.divIcon({
    html: `<div class="${cls}">${emoji}</div>`,
    className: "",
    iconSize: [28,28],
    iconAnchor: [14,14]
  });
}

function makeCarIcon() {
  return L.divIcon({
    html: `<div class="carIcon">üöó</div>`,
    className: "",
    iconSize: [18,18],
    iconAnchor: [9,9]
  });
}

/* ================= UTILS ================= */
function saveKey(){
  adminKey = document.getElementById("adminKey").value.trim();
  localStorage.setItem("adminKey", adminKey);
  document.getElementById("authMsg").innerHTML = adminKey ? "<span class='ok'>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>" : "<span class='err'>–ü—É—Å—Ç–æ</span>";
}

function showTab(tab){
  document.getElementById("panelHubs").style.display = (tab==="hubs") ? "block" : "none";
  document.getElementById("panelCars").style.display = (tab==="cars") ? "block" : "none";
  document.getElementById("tabHubs").classList.toggle("active", tab==="hubs");
  document.getElementById("tabCars").classList.toggle("active", tab==="cars");
}

async function api(url, opts={}){
  const headers = Object.assign({}, opts.headers || {});
  if (adminKey) headers["x-admin-key"] = adminKey;
  if (opts.json) headers["Content-Type"] = "application/json";

  const res = await fetch(url, {
    method: opts.method || "GET",
    headers,
    body: opts.json ? JSON.stringify(opts.json) : undefined
  });

  const data = await res.json().catch(()=>({}));
  if (!res.ok) throw new Error(data.error || "–û—à–∏–±–∫–∞ API");
  return data;
}

function option(id, text){
  const o = document.createElement("option");
  o.value = id;
  o.textContent = text;
  return o;
}

function haversineKm(a, b) {
  const R = 6371;
  const toRad = (x) => x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(s));
}

function parseLocalDatetimeToISO(v) {
  if (!v) return null;
  const d = new Date(v);
  if (Number.isNaN(d.getTime())) return null;
  return d.toISOString();
}

function isoToLocalDatetime(iso) {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ================= HUB LABELS ================= */
function hubLabel(h){
  const name = h.name_ru || h.code || h.id;
  return `${name} ‚Ä¢ ${hubTypeLabel(h.type)} ‚Ä¢ ${h.country}`;
}

/* ================= ROUTE EDITOR ================= */
function fillRouteAddSelect(){
  const sel = document.getElementById("routeAddHubSelect");
  sel.innerHTML = "";
  for (const h of allHubs) sel.appendChild(option(h.id, hubLabel(h)));
}

function renderRouteList(){
  const wrap = document.getElementById("routeList");
  wrap.innerHTML = "";

  if (!editingRouteHubIds.length) {
    wrap.innerHTML = `<div class="small muted">–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç. –ù–∞–∂–º–∏—Ç–µ "–°–æ–±—Ä–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ—á–∫–∏ –≤—Ä—É—á–Ω—É—é.</div>`;
    return;
  }

  editingRouteHubIds.forEach((hubId, idx) => {
    const h = hubsById.get(hubId);

    const row = document.createElement("div");
    row.className = "routeRow";

    const title = document.createElement("div");
    title.className = "routeRowTitle";
    title.textContent = `${idx+1}. ${h ? hubLabel(h) : hubId}`;

    const up = document.createElement("button");
    up.type = "button";
    up.textContent = "‚Üë";
    up.disabled = idx === 0;
    up.onclick = () => {
      const t = editingRouteHubIds[idx-1];
      editingRouteHubIds[idx-1] = editingRouteHubIds[idx];
      editingRouteHubIds[idx] = t;
      renderRouteList();
    };

    const down = document.createElement("button");
    down.type = "button";
    down.textContent = "‚Üì";
    down.disabled = idx === editingRouteHubIds.length-1;
    down.onclick = () => {
      const t = editingRouteHubIds[idx+1];
      editingRouteHubIds[idx+1] = editingRouteHubIds[idx];
      editingRouteHubIds[idx] = t;
      renderRouteList();
    };

    const del = document.createElement("button");
    del.type = "button";
    del.textContent = "–£–¥–∞–ª–∏—Ç—å";
    del.onclick = () => {
      editingRouteHubIds.splice(idx, 1);
      renderRouteList();
    };

    row.appendChild(title);
    row.appendChild(up);
    row.appendChild(down);
    row.appendChild(del);
    wrap.appendChild(row);
  });
}

function clearRouteEditor(){
  editingRouteHubIds = [];
  renderRouteList();
}

document.getElementById("routeAddBtn").addEventListener("click", () => {
  const id = document.getElementById("routeAddHubSelect").value;
  if (!id) return;
  editingRouteHubIds.push(id);
  renderRouteList();
});

/* ================= AUTO ROUTE BUILD ================= */
function getBorderPairById(id){
  return borderPairs.find(p => p.id === id) || null;
}

function chooseBorderPair(startCN, endRU, forcedPairId){
  if (!borderPairs.length) return null;

  if (forcedPairId) {
    const forced = getBorderPairById(forcedPairId);
    if (forced) return forced;
  }

  // –±–µ–∑–æ–ø–∞—Å–Ω–æ: sea –Ω–µ –≤—ã–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  const pool = borderPairs.filter(p => p.is_active && p.mode !== "sea");
  const candidates = pool.length ? pool : borderPairs.filter(p => p.is_active);

  let best = null;
  let bestScore = Infinity;

  for (const p of candidates) {
    const cn = hubsById.get(p.cn_hub_id);
    const ru = hubsById.get(p.ru_hub_id);
    if (!cn || !ru) continue;

    const score = haversineKm(startCN, cn) + haversineKm(ru, endRU);
    if (score < bestScore) { bestScore = score; best = p; }
  }

  return best;
}

function pointToSegmentDistKm(p, a, b){
  const ax = a.lng, ay = a.lat;
  const bx = b.lng, by = b.lat;
  const px = p.lng, py = p.lat;

  const abx = bx-ax, aby = by-ay;
  const apx = px-ax, apy = py-ay;
  const ab2 = abx*abx + aby*aby || 1e-9;
  let t = (apx*abx + apy*aby) / ab2;
  t = Math.max(0, Math.min(1, t));
  const cx = ax + abx*t;
  const cy = ay + aby*t;

  return haversineKm({lat:py, lng:px}, {lat:cy, lng:cx});
}

function pickIntermediateHubs(country, from, to, minCount, maxCount){
  const candidates = allHubs.filter(h =>
    h.country === country &&
    h.id !== from.id &&
    h.id !== to.id &&
    h.type !== "border"
  );
  if (!candidates.length) return [];

  const corridorKm = country === "CN" ? 250 : 300;

  const scored = candidates.map(h => ({
    h,
    dLine: pointToSegmentDistKm(h, from, to),
    dFrom: haversineKm(from, h),
    dTo: haversineKm(h, to)
  }));

  scored.sort((a,b) => (a.dLine - b.dLine) || ((a.dFrom+a.dTo) - (b.dFrom+b.dTo)));

  const near = scored.filter(x => x.dLine <= corridorKm);
  const pool = near.length ? near : scored;

  const take = Math.min(maxCount, pool.length);
  const picked = pool.slice(0, take).map(x => x.h);

  if (picked.length < minCount) return picked;
  if (picked.length > minCount && country === "CN") return picked.slice(0, minCount);

  return picked;
}

function autoBuildRoute(){
  const msg = document.getElementById("carMsg");
  msg.textContent = "";

  const startId = document.getElementById("carStartCN").value;
  const endId = document.getElementById("carEndRU").value;
  const forcedPairId = document.getElementById("carBorderPair").value || null;

  const startCN = hubsById.get(startId);
  const endRU = hubsById.get(endId);

  if (!startCN || !endRU) {
    msg.innerHTML = "<span class='err'>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—Ç (CN) –∏ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É (RU)</span>";
    return;
  }

  const pair = chooseBorderPair(startCN, endRU, forcedPairId);
  if (!pair) {
    msg.innerHTML = "<span class='err'>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä –≥—Ä–∞–Ω–∏—Ü—ã. –°–æ–∑–¥–∞–π—Ç–µ –∏—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–∞—Ä—ã –≥—Ä–∞–Ω–∏—Ü—ã¬ª.</span>";
    return;
  }

  const cnBorder = hubsById.get(pair.cn_hub_id);
  const ruBorder = hubsById.get(pair.ru_hub_id);
  if (!cnBorder || !ruBorder) {
    msg.innerHTML = "<span class='err'>–ü–∞—Ä–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ö–∞–±—ã (–æ–±–Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ)</span>";
    return;
  }

  // –∫–æ—Ä–∏–¥–æ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è land
  const cnWaypointIds = (pair.mode === "land" && Array.isArray(pair.cn_waypoint_ids))
    ? pair.cn_waypoint_ids
    : [];

  const cnForcedHubs = cnWaypointIds.map(id => hubsById.get(id)).filter(Boolean);
  const cnChain = [startCN, ...cnForcedHubs, cnBorder];

  // CN —Å–µ–≥–º–µ–Ω—Ç—ã: start -> (waypoints...) -> cnBorder
  let cnMids = [];
  for (let i = 0; i < cnChain.length - 1; i++) {
    const a = cnChain[i];
    const b = cnChain[i+1];
    const mids = pickIntermediateHubs("CN", a, b, 0, 3);
    cnMids.push(...mids);
  }

  // RU —Å–µ–≥–º–µ–Ω—Ç (–¥–æ 3)
  const ruMids = pickIntermediateHubs("RU", ruBorder, endRU, 0, 3);

  const ids = [
    startCN.id,
    ...cnMids.map(h => h.id),
    cnBorder.id,
    ruBorder.id,
    ...ruMids.map(h => h.id),
    endRU.id
  ];

  // —É–±—Ä–∞—Ç—å –ø–æ–¥—Ä—è–¥ –¥—É–±–ª–∏–∫–∞—Ç—ã
  const uniq = [];
  for (const id of ids) if (!uniq.length || uniq[uniq.length-1] !== id) uniq.push(id);

  // —É–±—Ä–∞—Ç—å –ª—é–±—ã–µ –¥—É–±–ª–∏
  const seen = new Set();
  const finalIds = [];
  for (const id of uniq) { if (!seen.has(id)) { seen.add(id); finalIds.push(id); } }

  editingRouteHubIds = finalIds;
  renderRouteList();

  msg.innerHTML = `<span class='ok'>–ú–∞—Ä—à—Ä—É—Ç —Å–æ–±—Ä–∞–Ω: ${pair.name} (${pair.mode})</span>`;
}

/* ================= FORMS ================= */
map.on("click", (e) => {
  if (document.getElementById("panelHubs").style.display !== "none") {
    document.getElementById("hubLat").value = e.latlng.lat.toFixed(6);
    document.getElementById("hubLng").value = e.latlng.lng.toFixed(6);
  }
});

function resetHubForm(){
  document.getElementById("hubId").value = "";
  document.getElementById("hubCode").value = "";
  document.getElementById("hubNameRu").value = "";
  document.getElementById("hubType").value = "hub";
  document.getElementById("hubDwell").value = "0.5";
  document.getElementById("hubMsg").textContent = "";
}

function fillHubForm(h){
  document.getElementById("hubId").value = h.id;
  document.getElementById("hubLat").value = Number(h.lat).toFixed(6);
  document.getElementById("hubLng").value = Number(h.lng).toFixed(6);
  document.getElementById("hubCountry").value = h.country;
  document.getElementById("hubCode").value = h.code;
  document.getElementById("hubNameRu").value = h.name_ru;
  document.getElementById("hubType").value = h.type || "hub";
  document.getElementById("hubDwell").value = String(h.dwell_days ?? 0.5);
}

async function saveHub(){
  const msg = document.getElementById("hubMsg");
  msg.textContent = "";
  try{
    const payload = {
      id: document.getElementById("hubId").value || undefined,
      country: document.getElementById("hubCountry").value,
      code: document.getElementById("hubCode").value,
      name_ru: document.getElementById("hubNameRu").value,
      type: document.getElementById("hubType").value,
      lat: document.getElementById("hubLat").value,
      lng: document.getElementById("hubLng").value,
      dwell_days: document.getElementById("hubDwell").value || 0.5
    };

    if (!payload.code || !payload.name_ru || payload.lat==="" || payload.lng==="") {
      throw new Error("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–¥, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã");
    }

    if (payload.id) {
      await api("/api/admin/hubs", { method:"PATCH", json: payload });
      msg.innerHTML = "<span class='ok'>–•–∞–± –æ–±–Ω–æ–≤–ª—ë–Ω</span>";
    } else {
      await api("/api/admin/hubs", { method:"POST", json: payload });
      msg.innerHTML = "<span class='ok'>–•–∞–± —Å–æ–∑–¥–∞–Ω</span>";
    }

    await loadAll();
    resetHubForm();
  }catch(e){
    msg.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

/* ===== border pair form ===== */
function resetPairForm(){
  document.getElementById("pairId").value = "";
  document.getElementById("pairName").value = "";
  document.getElementById("pairMode").value = "land";
  document.getElementById("pairActive").value = "true";
  // selects –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
  document.getElementById("pairMsg").textContent = "";
  // —Å–±—Ä–æ—Å multi-select
  const ms = document.getElementById("pairWaypoints");
  for (const opt of ms.options) opt.selected = false;
}

function fillPairForm(p){
  document.getElementById("pairId").value = p.id;
  document.getElementById("pairName").value = p.name || "";
  document.getElementById("pairMode").value = p.mode || "land";
  document.getElementById("pairCnHub").value = p.cn_hub_id;
  document.getElementById("pairRuHub").value = p.ru_hub_id;
  document.getElementById("pairActive").value = String(!!p.is_active);

  const ms = document.getElementById("pairWaypoints");
  const set = new Set(p.cn_waypoint_ids || []);
  for (const opt of ms.options) opt.selected = set.has(opt.value);
}

function getSelectedMulti(selId){
  const sel = document.getElementById(selId);
  const out = [];
  for (const opt of sel.options) if (opt.selected) out.push(opt.value);
  return out;
}

async function savePair(){
  const msg = document.getElementById("pairMsg");
  msg.textContent = "";
  try {
    const id = document.getElementById("pairId").value || "";
    const payload = {
      id: id || undefined,
      name: document.getElementById("pairName").value.trim(),
      mode: document.getElementById("pairMode").value,
      cn_hub_id: document.getElementById("pairCnHub").value,
      ru_hub_id: document.getElementById("pairRuHub").value,
      cn_waypoint_ids: getSelectedMulti("pairWaypoints"),
      is_active: document.getElementById("pairActive").value === "true"
    };

    if (!payload.name) throw new Error("–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—ã");
    if (!payload.cn_hub_id) throw new Error("–í—ã–±–µ—Ä–∏—Ç–µ CN –ø—É–Ω–∫—Ç –≥—Ä–∞–Ω–∏—Ü—ã");
    if (!payload.ru_hub_id) throw new Error("–í—ã–±–µ—Ä–∏—Ç–µ RU –ø—É–Ω–∫—Ç –≥—Ä–∞–Ω–∏—Ü—ã");

    // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞–Ω
    const cn = hubsById.get(payload.cn_hub_id);
    const ru = hubsById.get(payload.ru_hub_id);
    if (cn?.country !== "CN") throw new Error("CN –ø—É–Ω–∫—Ç –≥—Ä–∞–Ω–∏—Ü—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å country=CN");
    if (ru?.country !== "RU") throw new Error("RU –ø—É–Ω–∫—Ç –≥—Ä–∞–Ω–∏—Ü—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å country=RU");

    // waypoints –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å CN
    for (const wid of payload.cn_waypoint_ids) {
      const h = hubsById.get(wid);
      if (!h) throw new Error("–í –∫–æ—Ä–∏–¥–æ—Ä–Ω—ã—Ö —Ç–æ—á–∫–∞—Ö –µ—Å—Ç—å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ö–∞–± (–æ–±–Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ)");
      if (h.country !== "CN") throw new Error("–ö–æ—Ä–∏–¥–æ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ CN");
      if (h.type === "border") throw new Error("–ö–æ—Ä–∏–¥–æ—Ä–Ω–∞—è —Ç–æ—á–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å border");
    }

    if (id) {
      await api("/api/admin/border_pairs", { method:"PATCH", json: payload });
      msg.innerHTML = "<span class='ok'>–ü–∞—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞</span>";
    } else {
      await api("/api/admin/border_pairs", { method:"POST", json: payload });
      msg.innerHTML = "<span class='ok'>–ü–∞—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞</span>";
    }

    await loadAll();
    resetPairForm();
  } catch(e) {
    msg.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

/* ================= CARS ================= */
function resetCarForm(){
  document.getElementById("carId").value = "";
  document.getElementById("carVin").value = "";
  document.getElementById("carContract").value = "";
  document.getElementById("carBrand").value = "";
  document.getElementById("carModel").value = "";
  document.getElementById("carPhoto").value = "";
  document.getElementById("carUrgency").value = "std";
  document.getElementById("carStartTime").value = "";
  document.getElementById("carPublic").value = "true";
  document.getElementById("carMsg").textContent = "";
  editingRouteHubIds = [];
  renderRouteList();
}

function fillCarForm(c){
  document.getElementById("carId").value = c.id;
  document.getElementById("carVin").value = c.vin || "";
  document.getElementById("carContract").value = c.contract_no || "";
  document.getElementById("carBrand").value = c.brand || "";
  document.getElementById("carModel").value = c.model || "";
  document.getElementById("carPhoto").value = c.photo_url || "";
  document.getElementById("carUrgency").value = c.urgency || "std";
  document.getElementById("carStartTime").value = isoToLocalDatetime(c.start_time);
  document.getElementById("carPublic").value = String(!!c.public);

  editingRouteHubIds = Array.isArray(c.route_hub_ids) ? c.route_hub_ids.slice() : [];
  renderRouteList();

  const first = editingRouteHubIds[0];
  const last = editingRouteHubIds[editingRouteHubIds.length-1];
  if (first && hubsById.get(first)?.country === "CN") document.getElementById("carStartCN").value = first;
  if (last && hubsById.get(last)?.country === "RU") document.getElementById("carEndRU").value = last;
}

async function saveCar(){
  const msg = document.getElementById("carMsg");
  msg.textContent = "";
  try{
    const id = document.getElementById("carId").value || "";
    const start_time = parseLocalDatetimeToISO(document.getElementById("carStartTime").value);
    if (!start_time) throw new Error("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É/–≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞");

    const route_hub_ids = editingRouteHubIds.filter(Boolean);
    if (route_hub_ids.length < 2) throw new Error("–ú–∞—Ä—à—Ä—É—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏");

    const first = hubsById.get(route_hub_ids[0]);
    const last = hubsById.get(route_hub_ids[route_hub_ids.length-1]);
    if (!first || !last) throw new Error("–ú–∞—Ä—à—Ä—É—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ö–∞–±—ã (–æ–±–Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ)");
    if (first.country !== "CN") throw new Error("–ü–µ—Ä–≤–æ–π —Ç–æ—á–∫–æ–π –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ—á–∫–∞ –≤ –ö–∏—Ç–∞–µ (CN)");
    if (last.country !== "RU") throw new Error("–ü–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–æ–π –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ—á–∫–∞ –≤ –†–æ—Å—Å–∏–∏ (RU)");

    const payload = {
      id: id || undefined,
      vin: document.getElementById("carVin").value.trim(),
      contract_no: document.getElementById("carContract").value.trim(),
      brand: document.getElementById("carBrand").value.trim(),
      model: document.getElementById("carModel").value.trim(),
      photo_url: document.getElementById("carPhoto").value.trim(),
      urgency: document.getElementById("carUrgency").value,
      start_time,
      route_hub_ids,
      public: document.getElementById("carPublic").value === "true"
    };

    if (!payload.vin || !payload.contract_no) throw new Error("–ù—É–∂–Ω—ã VIN –∏ ‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞");

    if (id) {
      await api("/api/admin/cars", { method:"PATCH", json: payload });
      msg.innerHTML = "<span class='ok'>–ê–≤—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ</span>";
    } else {
      await api("/api/admin/cars", { method:"POST", json: payload });
      msg.innerHTML = "<span class='ok'>–ê–≤—Ç–æ —Å–æ–∑–¥–∞–Ω–æ</span>";
    }

    await loadAll();
    resetCarForm();
  }catch(e){
    msg.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

async function searchCars(){
  const q = document.getElementById("carSearch").value.trim();
  const out = document.getElementById("carsList");
  out.textContent = "";
  try{
    const r = await api("/api/admin/cars?q=" + encodeURIComponent(q));
    const list = r.cars || [];
    out.innerHTML = list.map(c => {
      return `<div class="listItem">
        <b>${(c.brand||"")} ${(c.model||"")}</b>
        <span class="pill">${c.urgency === "fast" ? "–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç"}</span>
        <br/>
        <span class="small">VIN: ${c.vin} | –î–æ–≥–æ–≤–æ—Ä: ${c.contract_no}</span><br/>
        <span class="small muted">public: ${c.public} | deleted: ${c.is_deleted}</span><br/>
        <div class="row" style="margin-top:6px">
          <button onclick="editCar('${c.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button onclick="togglePublic('${c.id}', ${!c.public})">${c.public ? "–°–∫—Ä—ã—Ç—å" : "–ü–æ–∫–∞–∑–∞—Ç—å"}</button>
          <button onclick="setDeleted('${c.id}', true)">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>`;
    }).join("");
    window.__carsSearchCache = list;
  }catch(e){
    out.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

function editCar(id){
  const c = (window.__carsSearchCache || []).find(x=>x.id===id);
  if (!c) return;
  fillCarForm(c);
  showTab("cars");
}

async function togglePublic(id, val){
  await api("/api/admin/cars", { method:"PATCH", json:{ id, public: val } });
  await searchCars();
}

async function setDeleted(id, val){
  await api("/api/admin/cars", { method:"PATCH", json:{ id, is_deleted: val } });
  await searchCars();
}

/* ================= MAP RENDER ================= */
function renderHubsOnMap(){
  hubLayer.clearLayers();
  hubMarkersById.clear();

  for (const h of hubs) {
    if (typeof h.lat !== "number" || typeof h.lng !== "number") continue;

    const isActive = carsCache.some(c =>
      c.pos && haversineKm(c.pos, { lat:h.lat, lng:h.lng }) < ACTIVE_HUB_RADIUS_KM
    );

    const mk = L.marker([h.lat, h.lng], { icon: makeHubIcon(h, isActive) })
      .bindTooltip(
        `${h.name_ru || "–•–∞–±"} ‚Ä¢ ${hubTypeLabel(h.type)} ‚Ä¢ ${h.country}${isActive ? " ‚Ä¢ –∞–∫—Ç–∏–≤–Ω—ã–π" : ""}`,
        { direction:"top", offset:[0,-10] }
      );

    mk.on("click", () => {
      fillHubForm(h);
      showTab("hubs");
    });

    hubMarkersById.set(h.id, mk);
    hubLayer.addLayer(mk);
  }
}

function renderCarsOnMap(){
  carLayer.clearLayers();
  carMarkersById.clear();

  for (const c of carsCache) {
    if (!c.pos) continue;

    const mk = L.marker([c.pos.lat, c.pos.lng], { icon: makeCarIcon() })
      .bindPopup(`<b>${(c.brand||"")} ${(c.model||"")}</b><br/><span class="small">${c.status||""}</span>`);

    mk.on("click", () => { showTab("cars"); });

    carMarkersById.set(c.id, mk);
    carLayer.addLayer(mk);
  }
}

/* ================= SELECTS ================= */
function fillStartEndSelects(){
  const startSel = document.getElementById("carStartCN");
  const endSel = document.getElementById("carEndRU");
  startSel.innerHTML = "";
  endSel.innerHTML = "";

  const cn = allHubs.filter(x=>x.country==="CN");
  const ru = allHubs.filter(x=>x.country==="RU");

  for (const h of cn) startSel.appendChild(option(h.id, `${h.name_ru} [${h.code}] (${hubTypeLabel(h.type)})`));
  for (const h of ru) endSel.appendChild(option(h.id, `${h.name_ru} [${h.code}] (${hubTypeLabel(h.type)})`));
}

function fillPairsSelectForCars(){
  const sel = document.getElementById("carBorderPair");
  sel.innerHTML = "";
  sel.appendChild(option("", "‚Äî –ê–≤—Ç–æ–≤—ã–±–æ—Ä (–±–µ–∑ sea) ‚Äî"));
  for (const p of borderPairs.filter(x=>x.is_active)) {
    sel.appendChild(option(p.id, `${p.name} (${p.mode})`));
  }
}

function fillPairsFormSelects(){
  const cnSel = document.getElementById("pairCnHub");
  const ruSel = document.getElementById("pairRuHub");
  const wpSel = document.getElementById("pairWaypoints");

  cnSel.innerHTML = "";
  ruSel.innerHTML = "";
  wpSel.innerHTML = "";

  const cnBorders = allHubs.filter(h => h.country==="CN" && h.type==="border");
  const ruBorders = allHubs.filter(h => h.country==="RU" && h.type==="border");
  const cnCandidates = allHubs.filter(h => h.country==="CN" && h.type !== "border");

  for (const h of cnBorders) cnSel.appendChild(option(h.id, `${h.name_ru} [${h.code}]`));
  for (const h of ruBorders) ruSel.appendChild(option(h.id, `${h.name_ru} [${h.code}]`));
  for (const h of cnCandidates) wpSel.appendChild(option(h.id, `${h.name_ru} [${h.code}] (${hubTypeLabel(h.type)})`));
}

function renderPairsList(){
  const el = document.getElementById("pairsList");
  const list = borderPairs.slice().sort((a,b)=> (b.created_at||"").localeCompare(a.created_at||""));
  el.innerHTML = list.map(p => {
    const cn = hubsById.get(p.cn_hub_id);
    const ru = hubsById.get(p.ru_hub_id);
    const wpCount = (p.cn_waypoint_ids || []).length;
    return `
      <div class="listItem">
        <b>${p.name}</b>
        <span class="pill">${p.mode}</span>
        <span class="pill">${p.is_active ? "active" : "inactive"}</span><br/>
        <span class="small">CN: ${cn ? cn.name_ru : p.cn_hub_id} ‚Üí RU: ${ru ? ru.name_ru : p.ru_hub_id}</span><br/>
        <span class="small muted">CN waypoints: ${wpCount}</span><br/>
        <div class="row" style="margin-top:6px">
          <button onclick="editPair('${p.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button onclick="togglePairActive('${p.id}', ${!p.is_active})">${p.is_active ? "–û—Ç–∫–ª—é—á–∏—Ç—å" : "–í–∫–ª—é—á–∏—Ç—å"}</button>
        </div>
      </div>
    `;
  }).join("");
}

function editPair(id){
  const p = borderPairs.find(x => x.id === id);
  if (!p) return;
  fillPairForm(p);
  showTab("hubs");
}

async function togglePairActive(id, is_active){
  await api("/api/admin/border_pairs", { method:"PATCH", json:{ id, is_active } });
  await loadAll();
}

/* ================= LOAD ALL ================= */
async function loadAll(){
  try {
    const h = await api("/api/admin/hubs");
    hubs = h.hubs || [];
    allHubs = hubs.slice();
    hubsById = new Map(allHubs.map(x => [x.id, x]));
    document.getElementById("hubsList").textContent = "–•–∞–±–æ–≤: " + hubs.length;

    const bp = await api("/api/admin/border_pairs");
    borderPairs = bp.border_pairs || [];

    const pub = await fetch("/api/public?t=" + Date.now(), { cache:"no-store" }).then(r=>r.json());
    carsCache = (pub.cars || []).filter(x=>x.pos);

    fillRouteAddSelect();
    fillStartEndSelects();
    fillPairsSelectForCars();
    fillPairsFormSelects();
    renderPairsList();

    renderRouteList();
    renderHubsOnMap();
    renderCarsOnMap();
  } catch(e){
    alert(e.message + "\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å (ADMIN_PASS) –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.");
  }
}

loadAll();
setInterval(loadAll, 60_000);
</script>
</body>
</html>
