<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–¥–º–∏–Ω–∫–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display:grid; grid-template-columns: 1fr 430px; height:100vh; }
    #map { height:100vh; }
    .side { border-left:1px solid #eee; padding:12px; overflow:auto; background:#fff; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px; }
    label { display:block; font-size:12px; color:#666; margin:8px 0 4px; }
    input, select { width:100%; padding:9px; border:1px solid #ddd; border-radius:10px; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .small { font-size:12px; color:#666; }
    .ok { color:#0a7; }
    .err { color:#d33; }
    .tabs { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .tab { padding:8px 10px; border:1px solid #ddd; border-radius:999px; cursor:pointer; }
    .tab.active { background:#f3f3f3; }
    .listItem { border-top:1px dashed #eee; padding:8px 0; }
    .pill { display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#f6f6f6; margin-left:6px; }
    .muted { color:#888; }
    .sep { border:none;border-top:1px dashed #eee;margin:12px 0; }

    .carIcon { font-size:18px; transform: translate(-6px,-10px); filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25)); user-select:none; }
    .hubIcon {
      font-size:18px;
      width:28px; height:28px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:#e0e0e0;
      border:2px solid #555;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
      user-select:none;
    }
    .hubIcon.active { background:#333; border-color:#000; color:#fff; }

    .routeRow{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid rgba(0,0,0,0.1);
      border-radius:10px; margin:6px 0;
    }
    .routeRowTitle{ flex:1; font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map"></div>

  <div class="side">
    <div class="card">
      <b>–î–æ—Å—Ç—É–ø</b>
      <div class="small">–í–≤–µ–¥–∏—Ç–µ ADMIN_PASS (–æ–¥–∏–Ω –æ–±—â–∏–π –ø–∞—Ä–æ–ª—å).</div>
      <label>–ü–∞—Ä–æ–ª—å</label>
      <input id="adminKey" type="password" placeholder="ADMIN_PASS" />
      <button onclick="saveKey()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div id="authMsg" class="small"></div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabHubs" onclick="showTab('hubs')">–•–∞–±—ã</div>
      <div class="tab" id="tabCars" onclick="showTab('cars')">–ê–≤—Ç–æ</div>
    </div>

    <!-- HUBS -->
    <div id="panelHubs" class="card">
      <b>–•–∞–±—ã</b>
      <div class="small">–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Üí –∑–∞–ø–æ–ª–Ω–∏—Ç—å ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ö–ª–∏–∫ –ø–æ —Ö–∞–±—É –Ω–∞ –∫–∞—Ä—Ç–µ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.</div>

      <input id="hubId" type="hidden" />

      <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label>
      <div class="row">
        <input id="hubLat" placeholder="lat" />
        <input id="hubLng" placeholder="lng" />
      </div>

      <label>–°—Ç—Ä–∞–Ω–∞</label>
      <select id="hubCountry">
        <option value="CN">–ö–∏—Ç–∞–π</option>
        <option value="RU">–†–æ—Å—Å–∏—è</option>
      </select>

      <label>–ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä HEIHE)</label>
      <input id="hubCode" placeholder="CODE" />

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å)</label>
      <input id="hubNameRu" placeholder="–•—ç–π—Ö—ç (Heihe)" />

      <label>–¢–∏–ø –ø—É–Ω–∫—Ç–∞</label>
      <select id="hubType">
        <option value="hub">üè≠ –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ö–∞–±</option>
        <option value="border">üöß –ì—Ä–∞–Ω–∏—Ü–∞</option>
        <option value="office">üè¢ –ù–∞—à –æ—Ñ–∏—Å</option>
        <option value="service">üè™ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ / –°–µ—Ä–≤–∏—Å-–ø–∞—Ä—Ç–Ω—ë—Ä</option>
      </select>

      <label>–°—Ä–æ–∫ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ö–∞–±–∞ (—Å—É—Ç–∫–∏)</label>
      <input id="hubDwell" placeholder="0.5" />

      <div class="row">
        <button onclick="saveHub()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="resetHubForm()">–ù–æ–≤—ã–π</button>
      </div>

      <div id="hubMsg" class="small"></div>
      <hr class="sep">
      <button onclick="loadAll()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      <div id="hubsList" class="small"></div>
    </div>

    <!-- CARS -->
    <div id="panelCars" class="card" style="display:none">
      <b>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</b>
      <div class="small">–°–æ–∑–¥–∞–Ω–∏–µ + —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ö–ª–∏–∫ –ø–æ –º–∞—à–∏–Ω–µ –Ω–∞ –∫–∞—Ä—Ç–µ –æ—Ç–∫—Ä–æ–µ—Ç –µ—ë –∫–∞—Ä—Ç–æ—á–∫—É (–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è).</div>

      <input id="carId" type="hidden" />

      <label>VIN (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∫–∞)</label>
      <input id="carVin" placeholder="VIN" />

      <label>‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∫–∞)</label>
      <input id="carContract" placeholder="‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞" />

      <label>–ú–∞—Ä–∫–∞</label>
      <input id="carBrand" placeholder="Toyota" />

      <label>–ú–æ–¥–µ–ª—å</label>
      <input id="carModel" placeholder="RAV4" />

      <label>–§–æ—Ç–æ (URL)</label>
      <input id="carPhoto" placeholder="https://..." />

      <label>–°—Ä–æ—á–Ω–æ—Å—Ç—å</label>
      <select id="carUrgency">
        <option value="std">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
        <option value="fast">–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è</option>
      </select>

      <label>–°—Ç–∞—Ä—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ (–¥–∞—Ç–∞/–≤—Ä–µ–º—è)</label>
      <input id="carStartTime" type="datetime-local" />

      <label>–ü–æ–∫–∞–∑ –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–π –∫–∞—Ä—Ç–µ</label>
      <select id="carPublic">
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
      </select>

      <label>–£–¥–∞–ª—ë–Ω (soft delete)</label>
      <select id="carDeleted">
        <option value="false">–ù–µ—Ç</option>
        <option value="true">–î–∞</option>
      </select>

      <hr class="sep">
      <b>–ú–∞—Ä—à—Ä—É—Ç (—Ä—É—á–Ω–∞—è –ø—Ä–∞–≤–∫–∞)</b>
      <div class="small">–î–æ–±–∞–≤–ª—è–π—Ç–µ/—É–¥–∞–ª—è–π—Ç–µ/–¥–≤–∏–≥–∞–π—Ç–µ —Ç–æ—á–∫–∏ ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ route_hub_ids.</div>

      <div class="row" style="margin-top:8px">
        <select id="routeAddHubSelect"></select>
        <button type="button" id="routeAddBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div id="routeList" style="margin-top:10px"></div>

      <div class="row" style="margin-top:10px">
        <button onclick="saveCar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="resetCarForm()">–ù–æ–≤—ã–π</button>
      </div>

      <div id="carMsg" class="small"></div>

      <hr class="sep">
      <b>–ü–æ–∏—Å–∫</b>
      <label>VIN –∏–ª–∏ –¥–æ–≥–æ–≤–æ—Ä</label>
      <div class="row">
        <input id="carSearch" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä JTM..." />
        <button onclick="searchCars()">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="carsList" class="small"></div>
    </div>
  </div>
</div>

<script>
/* ================= MAP ================= */
const map = L.map('map').setView([50.5, 127.5], 4);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '' }).addTo(map);

const hubLayer = L.layerGroup().addTo(map);
const carLayer = L.layerGroup().addTo(map);

let adminKey = localStorage.getItem("adminKey") || "";
document.getElementById("adminKey").value = adminKey;

let hubs = [];
let carsCache = [];
let hubsById = new Map();

let editingRouteHubIds = [];

const ACTIVE_HUB_RADIUS_KM = 10;

/* ================= UTILS ================= */
function saveKey(){
  adminKey = document.getElementById("adminKey").value.trim();
  localStorage.setItem("adminKey", adminKey);
  document.getElementById("authMsg").innerHTML = adminKey ? "<span class='ok'>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>" : "<span class='err'>–ü—É—Å—Ç–æ</span>";
}

function showTab(tab){
  document.getElementById("panelHubs").style.display = (tab==="hubs") ? "block" : "none";
  document.getElementById("panelCars").style.display = (tab==="cars") ? "block" : "none";
  document.getElementById("tabHubs").classList.toggle("active", tab==="hubs");
  document.getElementById("tabCars").classList.toggle("active", tab==="cars");
}

async function api(url, opts={}){
  const headers = Object.assign({}, opts.headers || {});
  if (adminKey) headers["x-admin-key"] = adminKey;
  if (opts.json) headers["Content-Type"] = "application/json";

  const res = await fetch(url, {
    method: opts.method || "GET",
    headers,
    body: opts.json ? JSON.stringify(opts.json) : undefined
  });

  const data = await res.json().catch(()=>({}));
  if (!res.ok) throw new Error(data.error || "–û—à–∏–±–∫–∞ API");
  return data;
}

function option(id, text){
  const o = document.createElement("option");
  o.value = id;
  o.textContent = text;
  return o;
}

function haversineKm(a, b) {
  const R = 6371;
  const toRad = (x) => x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(s));
}

function hubTypeLabel(t){
  if (t === "border") return "–ì—Ä–∞–Ω–∏—Ü–∞";
  if (t === "office") return "–û—Ñ–∏—Å";
  if (t === "service") return "–°–µ—Ä–≤–∏—Å/–í—ã–¥–∞—á–∞";
  return "–•–∞–±";
}

function hubEmoji(type) {
  if (type === "border") return "üöß";
  if (type === "office") return "üè¢";
  if (type === "service") return "üè™";
  return "üè≠";
}

function makeHubIcon(hub, active) {
  const emoji = hubEmoji(hub.type);
  const cls = active ? "hubIcon active" : "hubIcon";
  return L.divIcon({
    html: `<div class="${cls}">${emoji}</div>`,
    className: "",
    iconSize: [28,28],
    iconAnchor: [14,14]
  });
}

function makeCarIcon() {
  return L.divIcon({
    html: `<div class="carIcon">üöó</div>`,
    className: "",
    iconSize: [18,18],
    iconAnchor: [9,9]
  });
}

function parseLocalDatetimeToISO(v) {
  if (!v) return null;
  const d = new Date(v);
  if (Number.isNaN(d.getTime())) return null;
  return d.toISOString();
}

function isoToLocalDatetime(iso) {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ================= HUB FORM ================= */
map.on("click", (e) => {
  if (document.getElementById("panelHubs").style.display !== "none") {
    document.getElementById("hubLat").value = e.latlng.lat.toFixed(6);
    document.getElementById("hubLng").value = e.latlng.lng.toFixed(6);
  }
});

function resetHubForm(){
  document.getElementById("hubId").value = "";
  document.getElementById("hubCode").value = "";
  document.getElementById("hubNameRu").value = "";
  document.getElementById("hubType").value = "hub";
  document.getElementById("hubDwell").value = "0.5";
  document.getElementById("hubMsg").textContent = "";
}

function fillHubForm(h){
  document.getElementById("hubId").value = h.id;
  document.getElementById("hubLat").value = Number(h.lat).toFixed(6);
  document.getElementById("hubLng").value = Number(h.lng).toFixed(6);
  document.getElementById("hubCountry").value = h.country;
  document.getElementById("hubCode").value = h.code;
  document.getElementById("hubNameRu").value = h.name_ru;
  document.getElementById("hubType").value = h.type || "hub";
  document.getElementById("hubDwell").value = String(h.dwell_days ?? 0.5);
}

async function saveHub(){
  const msg = document.getElementById("hubMsg");
  msg.textContent = "";
  try{
    const payload = {
      id: document.getElementById("hubId").value || undefined,
      country: document.getElementById("hubCountry").value,
      code: document.getElementById("hubCode").value,
      name_ru: document.getElementById("hubNameRu").value,
      type: document.getElementById("hubType").value,
      lat: document.getElementById("hubLat").value,
      lng: document.getElementById("hubLng").value,
      dwell_days: document.getElementById("hubDwell").value || 0.5
    };

    if (!payload.code || !payload.name_ru || payload.lat==="" || payload.lng==="") {
      throw new Error("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–¥, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã");
    }

    if (payload.id) {
      await api("/api/admin/hubs", { method:"PATCH", json: payload });
      msg.innerHTML = "<span class='ok'>–•–∞–± –æ–±–Ω–æ–≤–ª—ë–Ω</span>";
    } else {
      await api("/api/admin/hubs", { method:"POST", json: payload });
      msg.innerHTML = "<span class='ok'>–•–∞–± —Å–æ–∑–¥–∞–Ω</span>";
    }

    await loadAll();
    resetHubForm();
  }catch(e){
    msg.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

/* ================= ROUTE EDITOR ================= */
function hubLabel(h){
  const name = h.name_ru || h.code || h.id;
  return `${name} ‚Ä¢ ${hubTypeLabel(h.type)} ‚Ä¢ ${h.country}`;
}

function fillRouteAddSelect(){
  const sel = document.getElementById("routeAddHubSelect");
  sel.innerHTML = "";
  for (const h of hubs) sel.appendChild(option(h.id, hubLabel(h)));
}

function renderRouteList(){
  const wrap = document.getElementById("routeList");
  wrap.innerHTML = "";

  if (!editingRouteHubIds.length) {
    wrap.innerHTML = `<div class="small muted">–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ—á–∫–∏ –≤—Ä—É—á–Ω—É—é.</div>`;
    return;
  }

  editingRouteHubIds.forEach((hubId, idx) => {
    const h = hubsById.get(hubId);

    const row = document.createElement("div");
    row.className = "routeRow";

    const title = document.createElement("div");
    title.className = "routeRowTitle";
    title.textContent = `${idx+1}. ${h ? hubLabel(h) : hubId}`;

    const up = document.createElement("button");
    up.type = "button";
    up.textContent = "‚Üë";
    up.disabled = idx === 0;
    up.onclick = () => {
      const t = editingRouteHubIds[idx-1];
      editingRouteHubIds[idx-1] = editingRouteHubIds[idx];
      editingRouteHubIds[idx] = t;
      renderRouteList();
    };

    const down = document.createElement("button");
    down.type = "button";
    down.textContent = "‚Üì";
    down.disabled = idx === editingRouteHubIds.length-1;
    down.onclick = () => {
      const t = editingRouteHubIds[idx+1];
      editingRouteHubIds[idx+1] = editingRouteHubIds[idx];
      editingRouteHubIds[idx] = t;
      renderRouteList();
    };

    const del = document.createElement("button");
    del.type = "button";
    del.textContent = "–£–¥–∞–ª–∏—Ç—å";
    del.onclick = () => {
      editingRouteHubIds.splice(idx, 1);
      renderRouteList();
    };

    row.appendChild(title);
    row.appendChild(up);
    row.appendChild(down);
    row.appendChild(del);
    wrap.appendChild(row);
  });
}

document.getElementById("routeAddBtn").addEventListener("click", () => {
  const id = document.getElementById("routeAddHubSelect").value;
  if (!id) return;
  editingRouteHubIds.push(id);
  renderRouteList();
});

/* ================= CARS ================= */
function resetCarForm(){
  document.getElementById("carId").value = "";
  document.getElementById("carVin").value = "";
  document.getElementById("carContract").value = "";
  document.getElementById("carBrand").value = "";
  document.getElementById("carModel").value = "";
  document.getElementById("carPhoto").value = "";
  document.getElementById("carUrgency").value = "std";
  document.getElementById("carStartTime").value = "";
  document.getElementById("carPublic").value = "true";
  document.getElementById("carDeleted").value = "false";
  document.getElementById("carMsg").textContent = "";
  editingRouteHubIds = [];
  renderRouteList();
}

function fillCarForm(c){
  document.getElementById("carId").value = c.id;
  document.getElementById("carVin").value = c.vin || "";
  document.getElementById("carContract").value = c.contract_no || "";
  document.getElementById("carBrand").value = c.brand || "";
  document.getElementById("carModel").value = c.model || "";
  document.getElementById("carPhoto").value = c.photo_url || "";
  document.getElementById("carUrgency").value = c.urgency || "std";
  document.getElementById("carStartTime").value = isoToLocalDatetime(c.start_time);
  document.getElementById("carPublic").value = String(!!c.public);
  document.getElementById("carDeleted").value = String(!!c.is_deleted);

  editingRouteHubIds = Array.isArray(c.route_hub_ids) ? c.route_hub_ids.slice() : [];
  renderRouteList();
}

async function loadCarById(id){
  const r = await api("/api/admin/cars?id=" + encodeURIComponent(id));
  if (!r || !r.car) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ");
  fillCarForm(r.car);
  showTab("cars");
}

async function saveCar(){
  const msg = document.getElementById("carMsg");
  msg.textContent = "";
  try{
    const id = document.getElementById("carId").value || "";
    const start_time = parseLocalDatetimeToISO(document.getElementById("carStartTime").value);
    if (!start_time) throw new Error("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É/–≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞");

    const route_hub_ids = editingRouteHubIds.filter(Boolean);
    if (route_hub_ids.length < 2) throw new Error("–ú–∞—Ä—à—Ä—É—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏");

    const payload = {
      id: id || undefined,
      vin: document.getElementById("carVin").value.trim(),
      contract_no: document.getElementById("carContract").value.trim(),
      brand: document.getElementById("carBrand").value.trim(),
      model: document.getElementById("carModel").value.trim(),
      photo_url: document.getElementById("carPhoto").value.trim(),
      urgency: document.getElementById("carUrgency").value,
      start_time,
      route_hub_ids,
      public: document.getElementById("carPublic").value === "true",
      is_deleted: document.getElementById("carDeleted").value === "true"
    };

    if (!payload.vin || !payload.contract_no) throw new Error("–ù—É–∂–Ω—ã VIN –∏ ‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞");

    if (id) {
      await api("/api/admin/cars", { method:"PATCH", json: payload });
      msg.innerHTML = "<span class='ok'>–ê–≤—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ</span>";
    } else {
      await api("/api/admin/cars", { method:"POST", json: payload });
      msg.innerHTML = "<span class='ok'>–ê–≤—Ç–æ —Å–æ–∑–¥–∞–Ω–æ</span>";
    }

    await loadAll();
  }catch(e){
    msg.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

async function searchCars(){
  const q = document.getElementById("carSearch").value.trim();
  const out = document.getElementById("carsList");
  out.textContent = "";
  try{
    const r = await api("/api/admin/cars?q=" + encodeURIComponent(q));
    const list = r.cars || [];
    out.innerHTML = list.map(c => {
      return `<div class="listItem">
        <b>${(c.brand||"")} ${(c.model||"")}</b>
        <span class="pill">${c.urgency === "fast" ? "–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç"}</span>
        <br/>
        <span class="small">VIN: ${c.vin} | –î–æ–≥–æ–≤–æ—Ä: ${c.contract_no}</span><br/>
        <span class="small muted">public: ${c.public} | deleted: ${c.is_deleted}</span><br/>
        <div class="row" style="margin-top:6px">
          <button onclick="editCar('${c.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>`;
    }).join("");
    window.__carsSearchCache = list;
  }catch(e){
    out.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

function editCar(id){
  loadCarById(id).catch(e => alert(e.message));
}

/* ================= MAP RENDER ================= */
function renderHubsOnMap(){
  hubLayer.clearLayers();

  for (const h of hubs) {
    if (typeof h.lat !== "number" || typeof h.lng !== "number") continue;

    const isActive = carsCache.some(c =>
      c.pos && haversineKm(c.pos, { lat:h.lat, lng:h.lng }) < ACTIVE_HUB_RADIUS_KM
    );

    const mk = L.marker([h.lat, h.lng], { icon: makeHubIcon(h, isActive) })
      .bindTooltip(`${h.name_ru || "–•–∞–±"} ‚Ä¢ ${hubTypeLabel(h.type)} ‚Ä¢ ${h.country}`, { direction:"top", offset:[0,-10], sticky:true });

    mk.on("click", () => {
      fillHubForm(h);
      showTab("hubs");
    });

    hubLayer.addLayer(mk);
  }
}

function renderCarsOnMap(){
  carLayer.clearLayers();

  for (const c of carsCache) {
    if (!c.pos) continue;

    const mk = L.marker([c.pos.lat, c.pos.lng], { icon: makeCarIcon() })
      .bindPopup(`<b>${(c.brand||"")} ${(c.model||"")}</b><br/><span class="small">${c.status||""}</span>`);

    mk.on("click", async () => {
      try { await loadCarById(c.id); } catch(e){ alert(e.message); }
    });

    carLayer.addLayer(mk);
  }
}

/* ================= LOAD ALL ================= */
async function loadAll(){
  try {
    const h = await api("/api/admin/hubs");
    hubs = h.hubs || [];
    hubsById = new Map(hubs.map(x => [x.id, x]));
    document.getElementById("hubsList").textContent = "–•–∞–±–æ–≤: " + hubs.length;

    fillRouteAddSelect();
    renderRouteList();

    const pub = await fetch("/api/public?t=" + Date.now(), { cache:"no-store" }).then(r=>r.json());
    carsCache = (pub.cars || []).filter(x=>x.pos);

    renderHubsOnMap();
    renderCarsOnMap();
  } catch(e){
    alert(e.message + "\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å (ADMIN_PASS) –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.");
  }
}

loadAll();
setInterval(loadAll, 60_000);
</script>
</body>
</html>
