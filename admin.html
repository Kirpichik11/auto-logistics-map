<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–¥–º–∏–Ω–∫–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display:grid; grid-template-columns: 1fr 430px; height:100vh; }
    #map { height:100vh; }
    .side { border-left:1px solid #eee; padding:12px; overflow:auto; background:#fff; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px; }
    label { display:block; font-size:12px; color:#666; margin:8px 0 4px; }
    input, select { width:100%; padding:9px; border:1px solid #ddd; border-radius:10px; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .small { font-size:12px; color:#666; }
    .ok { color:#0a7; }
    .err { color:#d33; }
    .tabs { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .tab { padding:8px 10px; border:1px solid #ddd; border-radius:999px; cursor:pointer; }
    .tab.active { background:#f3f3f3; }
    .listItem { border-top:1px dashed #eee; padding:8px 0; }
    .pill { display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#f6f6f6; margin-left:6px; }
    .muted { color:#888; }

    /* Icons */
    .carIcon { font-size:18px; transform: translate(-6px,-10px); filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25)); user-select:none; }
    .hubIcon {
      font-size:18px;
      width:28px; height:28px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:#e0e0e0;
      border:2px solid #555;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
      user-select:none;
    }
    .hubIcon.active { background:#333; border-color:#000; color:#fff; }

    /* Route editor rows */
    .routeRow{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid rgba(0,0,0,0.1);
      border-radius:10px; margin:6px 0;
    }
    .routeRowTitle{ flex:1; font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map"></div>

  <div class="side">
    <div class="card">
      <b>–î–æ—Å—Ç—É–ø</b>
      <div class="small">–í–≤–µ–¥–∏—Ç–µ ADMIN_PASS (–æ–¥–∏–Ω –æ–±—â–∏–π –ø–∞—Ä–æ–ª—å).</div>
      <label>–ü–∞—Ä–æ–ª—å</label>
      <input id="adminKey" type="password" placeholder="ADMIN_PASS" />
      <button onclick="saveKey()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div id="authMsg" class="small"></div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabHubs" onclick="showTab('hubs')">–•–∞–±—ã</div>
      <div class="tab" id="tabCars" onclick="showTab('cars')">–ê–≤—Ç–æ</div>
    </div>

    <!-- HUBS -->
    <div id="panelHubs" class="card">
      <b>–•–∞–±—ã</b>
      <div class="small">–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Üí –∑–∞–ø–æ–ª–Ω–∏—Ç—å ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ö–ª–∏–∫ –ø–æ —Ö–∞–±—É –Ω–∞ –∫–∞—Ä—Ç–µ ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.</div>

      <input id="hubId" type="hidden" />

      <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</label>
      <div class="row">
        <input id="hubLat" placeholder="lat" />
        <input id="hubLng" placeholder="lng" />
      </div>

      <label>–°—Ç—Ä–∞–Ω–∞</label>
      <select id="hubCountry">
        <option value="CN">–ö–∏—Ç–∞–π</option>
        <option value="RU">–†–æ—Å—Å–∏—è</option>
      </select>

      <label>–ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä HEIHE)</label>
      <input id="hubCode" placeholder="CODE" />

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å)</label>
      <input id="hubNameRu" placeholder="–•—ç–π—Ö—ç (Heihe)" />

      <label>–¢–∏–ø –ø—É–Ω–∫—Ç–∞</label>
      <select id="hubType">
        <option value="hub">üè≠ –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ö–∞–±</option>
        <option value="border">üöß –ì—Ä–∞–Ω–∏—Ü–∞</option>
        <option value="office">üè¢ –ù–∞—à –æ—Ñ–∏—Å</option>
        <option value="service">üè™ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ / –°–µ—Ä–≤–∏—Å-–ø–∞—Ä—Ç–Ω—ë—Ä</option>
      </select>

      <label>–°—Ä–æ–∫ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ö–∞–±–∞ (—Å—É—Ç–∫–∏)</label>
      <input id="hubDwell" placeholder="0.5" />

      <div class="row">
        <button onclick="saveHub()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="resetHubForm()">–ù–æ–≤—ã–π</button>
      </div>

      <div id="hubMsg" class="small"></div>
      <hr style="border:none;border-top:1px dashed #eee;margin:12px 0">
      <button onclick="loadAll()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      <div id="hubsList" class="small"></div>
    </div>

    <!-- CARS -->
    <div id="panelCars" class="card" style="display:none">
      <b>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</b>
      <div class="small">–°–æ–∑–¥–∞–Ω–∏–µ + —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ú–∞—Ä—à—Ä—É—Ç –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –∑–∞—Ç–µ–º –≤—Ä—É—á–Ω—É—é –ø—Ä–∞–≤–∏—Ç—å.</div>

      <input id="carId" type="hidden" />

      <label>VIN (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∫–∞)</label>
      <input id="carVin" placeholder="VIN" />

      <label>‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∫–∞)</label>
      <input id="carContract" placeholder="‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞" />

      <label>–ú–∞—Ä–∫–∞</label>
      <input id="carBrand" placeholder="Toyota" />

      <label>–ú–æ–¥–µ–ª—å</label>
      <input id="carModel" placeholder="RAV4" />

      <label>–§–æ—Ç–æ (URL)</label>
      <input id="carPhoto" placeholder="https://..." />

      <label>–°—Ä–æ—á–Ω–æ—Å—Ç—å</label>
      <select id="carUrgency">
        <option value="std">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
        <option value="fast">–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è</option>
      </select>

      <label>–°—Ç–∞—Ä—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ (–¥–∞—Ç–∞/–≤—Ä–µ–º—è)</label>
      <input id="carStartTime" type="datetime-local" />

      <hr style="border:none;border-top:1px dashed #eee;margin:12px 0">

      <b>–ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞</b>
      <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—Ç (CN), –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É (RU) –∏ –ø–∞—Ä—É –≥—Ä–∞–Ω–∏—Ü—ã. –ó–∞—Ç–µ–º –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø—Ä–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –Ω–∏–∂–µ.</div>

      <label>–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ (–ö–∏—Ç–∞–π)</label>
      <select id="carStartCN"></select>

      <label>–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ (–†–æ—Å—Å–∏—è)</label>
      <select id="carEndRU"></select>

      <label>–ü–∞—Ä–∞ –≥—Ä–∞–Ω–∏—Ü—ã (CN ‚Üí RU)</label>
      <select id="carBorderPair"></select>

      <div class="row" style="margin-top:8px">
        <button type="button" onclick="autoBuildRoute()">–°–æ–±—Ä–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</button>
        <button type="button" onclick="clearRouteEditor()">–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
      </div>

      <hr style="border:none;border-top:1px dashed #eee;margin:12px 0">

      <b>–ú–∞—Ä—à—Ä—É—Ç (—Ä—É—á–Ω–∞—è –ø—Ä–∞–≤–∫–∞)</b>
      <div class="small">–î–æ–±–∞–≤–ª—è–π—Ç–µ/—É–¥–∞–ª—è–π—Ç–µ/–¥–≤–∏–≥–∞–π—Ç–µ —Ç–æ—á–∫–∏ ‚Äî —ç—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ route_hub_ids.</div>

      <div class="row" style="margin-top:8px">
        <select id="routeAddHubSelect"></select>
        <button type="button" id="routeAddBtn">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
      </div>

      <div id="routeList" style="margin-top:10px"></div>

      <label>–ü–æ–∫–∞–∑ –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–π –∫–∞—Ä—Ç–µ</label>
      <select id="carPublic">
        <option value="true">–î–∞</option>
        <option value="false">–ù–µ—Ç</option>
      </select>

      <div class="row">
        <button onclick="saveCar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="resetCarForm()">–ù–æ–≤—ã–π</button>
      </div>

      <div id="carMsg" class="small"></div>

      <hr style="border:none;border-top:1px dashed #eee;margin:12px 0">
      <b>–ü–æ–∏—Å–∫</b>
      <label>VIN –∏–ª–∏ –¥–æ–≥–æ–≤–æ—Ä</label>
      <div class="row">
        <input id="carSearch" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä JTM..." />
        <button onclick="searchCars()">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="carsList" class="small"></div>
    </div>

  </div>
</div>

<script>
/* ================= MAP ================= */
const map = L.map('map').setView([50.5, 127.5], 4);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19,
  attribution: ''
}).addTo(map);

const hubLayer = L.layerGroup().addTo(map);
const carLayer = L.layerGroup().addTo(map);

let adminKey = localStorage.getItem("adminKey") || "";
document.getElementById("adminKey").value = adminKey;

let hubs = [];
let carsCache = []; // –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ö–∞–±–æ–≤
let hubMarkersById = new Map();
let carMarkersById = new Map();

const ACTIVE_HUB_RADIUS_KM = 10;

// ==== Route editor state ====
let allHubs = [];
let editingRouteHubIds = []; // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π route_hub_ids, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω—è–µ–º
let hubsById = new Map();

function hubTypeLabel(t){
  if (t === "border") return "–ì—Ä–∞–Ω–∏—Ü–∞";
  if (t === "office") return "–û—Ñ–∏—Å";
  if (t === "service") return "–°–µ—Ä–≤–∏—Å/–í—ã–¥–∞—á–∞";
  return "–•–∞–±";
}

/**
 * ==== BORDER PAIRS CONFIG ====
 * –¢—É—Ç –º–µ–Ω–µ–¥–∂–µ—Ä/—Ç—ã –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ –ø–∞—Ä—ã –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ CODE (–∏–∑ hubs.code).
 * –í–∞–∂–Ω–æ: –≤ –ø–∞—Ä–µ –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å 2 —Ö–∞–±–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ hubs: –æ–¥–∏–Ω CN, –æ–¥–∏–Ω RU.
 */
const BORDER_PAIRS = [
  // –ü—Ä–∏–º–µ—Ä. –ó–ê–ú–ï–ù–ò –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ codes –∏–∑ —Ç–≤–æ–µ–π –±–∞–∑—ã:
  { id:"heihe-blag", name:"–•—ç–π—Ö—ç ‚Üí –ë–ª–∞–≥–æ–≤–µ—â–µ–Ω—Å–∫", cnCode:"HEIHE", ruCode:"BLAG" },
  { id:"suifenhe-uss", name:"–°—É–π—Ñ—ç–Ω—å—Ö—ç ‚Üí –£—Å—Å—É—Ä–∏–π—Å–∫", cnCode:"SUIFENHE", ruCode:"USSURIISK" },
  { id:"shanghai-vlad", name:"–®–∞–Ω—Ö–∞–π ‚Üí –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫", cnCode:"SHANGHAI", ruCode:"VLADIVOSTOK" },
];

/* ================= UTILS ================= */
function saveKey(){
  adminKey = document.getElementById("adminKey").value.trim();
  localStorage.setItem("adminKey", adminKey);
  document.getElementById("authMsg").innerHTML = adminKey ? "<span class='ok'>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>" : "<span class='err'>–ü—É—Å—Ç–æ</span>";
}

function showTab(tab){
  document.getElementById("panelHubs").style.display = (tab==="hubs") ? "block" : "none";
  document.getElementById("panelCars").style.display = (tab==="cars") ? "block" : "none";
  document.getElementById("tabHubs").classList.toggle("active", tab==="hubs");
  document.getElementById("tabCars").classList.toggle("active", tab==="cars");
}

async function api(url, opts={}){
  const headers = Object.assign({}, opts.headers || {});
  if (adminKey) headers["x-admin-key"] = adminKey;
  if (opts.json) headers["Content-Type"] = "application/json";

  const res = await fetch(url, {
    method: opts.method || "GET",
    headers,
    body: opts.json ? JSON.stringify(opts.json) : undefined
  });

  const data = await res.json().catch(()=>({}));
  if (!res.ok) throw new Error(data.error || "–û—à–∏–±–∫–∞ API");
  return data;
}

function option(id, text){
  const o = document.createElement("option");
  o.value = id;
  o.textContent = text;
  return o;
}

function haversineKm(a, b) {
  const R = 6371;
  const toRad = (x) => x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(s));
}

function hubEmoji(type) {
  if (type === "border") return "üöß";
  if (type === "office") return "üè¢";
  if (type === "service") return "üè™";
  return "üè≠";
}

function makeHubIcon(hub, active) {
  const emoji = hubEmoji(hub.type);
  const cls = active ? "hubIcon active" : "hubIcon";
  return L.divIcon({
    html: `<div class="${cls}">${emoji}</div>`,
    className: "",
    iconSize: [28,28],
    iconAnchor: [14,14]
  });
}

function makeCarIcon() {
  return L.divIcon({
    html: `<div class="carIcon">üöó</div>`,
    className: "",
    iconSize: [18,18],
    iconAnchor: [9,9]
  });
}

function parseLocalDatetimeToISO(v) {
  if (!v) return null;
  const d = new Date(v);
  if (Number.isNaN(d.getTime())) return null;
  return d.toISOString();
}

function isoToLocalDatetime(iso) {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ================= ROUTE EDITOR UI ================= */
function hubLabel(h){
  const name = h.name_ru || h.code || h.id;
  return `${name} ‚Ä¢ ${hubTypeLabel(h.type)} ‚Ä¢ ${h.country}`;
}

function fillRouteAddSelect(){
  const sel = document.getElementById("routeAddHubSelect");
  sel.innerHTML = "";
  for (const h of allHubs) sel.appendChild(option(h.id, hubLabel(h)));
}

function renderRouteList(){
  const wrap = document.getElementById("routeList");
  wrap.innerHTML = "";

  if (!editingRouteHubIds.length) {
    wrap.innerHTML = `<div class="small muted">–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç. –ù–∞–∂–º–∏—Ç–µ "–°–æ–±—Ä–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ—á–∫–∏ –≤—Ä—É—á–Ω—É—é.</div>`;
    return;
  }

  editingRouteHubIds.forEach((hubId, idx) => {
    const h = hubsById.get(hubId);

    const row = document.createElement("div");
    row.className = "routeRow";

    const title = document.createElement("div");
    title.className = "routeRowTitle";
    title.textContent = `${idx+1}. ${h ? hubLabel(h) : hubId}`;

    const up = document.createElement("button");
    up.type = "button";
    up.textContent = "‚Üë";
    up.disabled = idx === 0;
    up.onclick = () => {
      const t = editingRouteHubIds[idx-1];
      editingRouteHubIds[idx-1] = editingRouteHubIds[idx];
      editingRouteHubIds[idx] = t;
      renderRouteList();
    };

    const down = document.createElement("button");
    down.type = "button";
    down.textContent = "‚Üì";
    down.disabled = idx === editingRouteHubIds.length-1;
    down.onclick = () => {
      const t = editingRouteHubIds[idx+1];
      editingRouteHubIds[idx+1] = editingRouteHubIds[idx];
      editingRouteHubIds[idx] = t;
      renderRouteList();
    };

    const del = document.createElement("button");
    del.type = "button";
    del.textContent = "–£–¥–∞–ª–∏—Ç—å";
    del.onclick = () => {
      editingRouteHubIds.splice(idx, 1);
      renderRouteList();
    };

    row.appendChild(title);
    row.appendChild(up);
    row.appendChild(down);
    row.appendChild(del);
    wrap.appendChild(row);
  });
}

function clearRouteEditor(){
  editingRouteHubIds = [];
  renderRouteList();
}

document.getElementById("routeAddBtn").addEventListener("click", () => {
  const id = document.getElementById("routeAddHubSelect").value;
  if (!id) return;
  editingRouteHubIds.push(id);
  renderRouteList();
});

/* ================= AUTO ROUTE BUILD ================= */
/**
 * –ê–ª–≥–æ—Ä–∏—Ç–º (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞, –±–µ–∑ –≥—Ä–∞—Ñ–∞ –¥–æ—Ä–æ–≥):
 * 1) –í—ã–±–∏—Ä–∞–µ–º –ø–∞—Ä—É –≥—Ä–∞–Ω–∏—Ü—ã, –∫–æ—Ç–æ—Ä–∞—è –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç:
 *    dist(startCN -> borderCN) + dist(borderRU -> endRU)
 *    (–µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –≤—ã–±—Ä–∞–ª –ø–∞—Ä—É –≤—Ä—É—á–Ω—É—é ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë)
 * 2) CN —É—á–∞—Å—Ç–æ–∫: startCN -> ... -> borderCN
 *    - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫ –º–∏–Ω–∏–º—É–º 3 (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—ã)
 *    - –≤—ã–±–∏—Ä–∞–µ–º —Ö–∞–±—ã CN, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–∏–∑–∫–æ –∫ –ø—Ä—è–º–æ–π –ª–∏–Ω–∏–∏ (–∫–æ—Ä–∏–¥–æ—Ä),
 *      –∏–Ω–∞—á–µ –±–µ—Ä–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –∫ –ª–∏–Ω–∏–∏.
 * 3) RU —É—á–∞—Å—Ç–æ–∫: borderRU -> ... -> endRU
 *    - –º–∞–∫—Å–∏–º—É–º 3 –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏.
 */
function pointToSegmentDistKm(p, a, b){
  // –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω–æ: –ø—Ä–æ–µ–∫—Ü–∏—è –≤ "–ø–ª–æ—Å–∫–∏—Ö" –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (–¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —Ö–∞–±–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
  const ax = a.lng, ay = a.lat;
  const bx = b.lng, by = b.lat;
  const px = p.lng, py = p.lat;

  const abx = bx-ax, aby = by-ay;
  const apx = px-ax, apy = py-ay;
  const ab2 = abx*abx + aby*aby || 1e-9;
  let t = (apx*abx + apy*aby) / ab2;
  t = Math.max(0, Math.min(1, t));
  const cx = ax + abx*t;
  const cy = ay + aby*t;

  return haversineKm({lat:py, lng:px}, {lat:cy, lng:cx});
}

function chooseBorderPair(startCN, endRU, forcedPairId){
  if (!BORDER_PAIRS.length) return null;

  const byCode = new Map(allHubs.map(h => [h.code, h]));
  const pairsResolved = BORDER_PAIRS.map(p => ({
    ...p,
    cnHub: byCode.get(p.cnCode) || null,
    ruHub: byCode.get(p.ruCode) || null
  })).filter(p => p.cnHub && p.ruHub);

  if (!pairsResolved.length) return null;

  if (forcedPairId) {
    const forced = pairsResolved.find(p => p.id === forcedPairId);
    if (forced) return forced;
  }

  let best = null;
  let bestScore = Infinity;

  for (const p of pairsResolved) {
    const score = haversineKm(startCN, p.cnHub) + haversineKm(p.ruHub, endRU);
    if (score < bestScore) { bestScore = score; best = p; }
  }
  return best;
}

function pickIntermediateHubs(country, from, to, minCount, maxCount){
  const candidates = allHubs.filter(h =>
    h.country === country &&
    h.id !== from.id &&
    h.id !== to.id &&
    (h.type === "hub" || h.type === "service" || h.type === "office") // border –∏—Å–∫–ª—é—á–∞–µ–º
  );

  if (!candidates.length) return [];

  // –∫–æ—Ä–∏–¥–æ—Ä (—á–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º ‚Äú—Å–≤–æ–±–æ–¥–Ω–µ–µ‚Äù –≤—ã–±–æ—Ä)
  const corridorKm = country === "CN" ? 250 : 300;

  const scored = candidates.map(h => ({
    h,
    dLine: pointToSegmentDistKm(h, from, to),
    dFrom: haversineKm(from, h),
    dTo: haversineKm(h, to)
  }));

  // —Å–Ω–∞—á–∞–ª–∞ —Ç–µ, –∫—Ç–æ –±–ª–∏–∂–µ –∫ –ø—Ä—è–º–æ–π –ª–∏–Ω–∏–∏, –∑–∞—Ç–µ–º –ø–æ —Å—É–º–º–∞—Ä–Ω–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
  scored.sort((a,b) => (a.dLine - b.dLine) || ((a.dFrom+a.dTo) - (b.dFrom+b.dTo)));

  const near = scored.filter(x => x.dLine <= corridorKm);
  const pool = near.length ? near : scored;

  // –ë–µ—Ä–µ–º –¥–æ maxCount, –Ω–æ –º–∏–Ω–∏–º—É–º minCount (–µ—Å–ª–∏ –µ—Å—Ç—å)
  const take = Math.min(maxCount, pool.length);
  const picked = pool.slice(0, take).map(x => x.h);

  // –µ—Å–ª–∏ –Ω–∞–¥–æ –º–∏–Ω–∏–º—É–º, –∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –º–µ–Ω—å—à–µ ‚Äî –≤–µ—Ä–Ω–µ–º —á—Ç–æ –µ—Å—Ç—å
  if (picked.length < minCount) return picked;

  // –µ—Å–ª–∏ –±–æ–ª—å—à–µ minCount ‚Äî –æ—Å—Ç–∞–≤–∏–º minCount –Ω–∞ CN, –Ω–∞ RU –æ—Å—Ç–∞–≤–∏–º maxCount (–∫–∞–∫ –µ—Å—Ç—å)
  if (picked.length > minCount && country === "CN") return picked.slice(0, minCount);

  return picked;
}

function autoBuildRoute(){
  const msg = document.getElementById("carMsg");
  msg.textContent = "";

  const startId = document.getElementById("carStartCN").value;
  const endId = document.getElementById("carEndRU").value;
  const forcedPairId = document.getElementById("carBorderPair").value || null;

  const startCN = hubsById.get(startId);
  const endRU = hubsById.get(endId);

  if (!startCN || !endRU) {
    msg.innerHTML = "<span class='err'>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—Ç (CN) –∏ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É (RU)</span>";
    return;
  }

  const pair = chooseBorderPair(startCN, endRU, forcedPairId);
  if (!pair) {
    msg.innerHTML = "<span class='err'>–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–∞—Ä –≥—Ä–∞–Ω–∏—Ü—ã (BORDER_PAIRS). –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä—ã –ø–æ code –≤ admin.html</span>";
    return;
  }

  const cnBorder = pair.cnHub;
  const ruBorder = pair.ruHub;

  // CN: –º–∏–Ω–∏–º—É–º 3 –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö
  const cnMids = pickIntermediateHubs("CN", startCN, cnBorder, 3, 5);
  // RU: –º–∞–∫—Å–∏–º—É–º 3 –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö
  const ruMids = pickIntermediateHubs("RU", ruBorder, endRU, 0, 3);

  // –ú–∞—Ä—à—Ä—É—Ç: startCN -> cnMids -> cnBorder -> ruBorder -> ruMids -> endRU
  const ids = [];
  ids.push(startCN.id);
  for (const h of cnMids) ids.push(h.id);
  ids.push(cnBorder.id);
  ids.push(ruBorder.id);
  for (const h of ruMids) ids.push(h.id);
  ids.push(endRU.id);

  // —É–±—Ä–∞—Ç—å –ø–æ–¥—Ä—è–¥ –¥—É–±–ª–∏–∫–∞—Ç—ã (–Ω–∞ –≤—Å—è–∫–∏–π)
  const uniq = [];
  for (const id of ids) {
    if (!uniq.length || uniq[uniq.length-1] !== id) uniq.push(id);
  }

  editingRouteHubIds = uniq;
  renderRouteList();

  msg.innerHTML = `<span class='ok'>–ú–∞—Ä—à—Ä—É—Ç —Å–æ–±—Ä–∞–Ω: ${pair.name}</span>`;
}

/* ================= FORMS ================= */
map.on("click", (e) => {
  // —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ –•–∞–±—ã: –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ —Å—Ç–∞–≤–∏—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
  if (document.getElementById("panelHubs").style.display !== "none") {
    document.getElementById("hubLat").value = e.latlng.lat.toFixed(6);
    document.getElementById("hubLng").value = e.latlng.lng.toFixed(6);
  }
});

function resetHubForm(){
  document.getElementById("hubId").value = "";
  document.getElementById("hubCode").value = "";
  document.getElementById("hubNameRu").value = "";
  document.getElementById("hubType").value = "hub";
  document.getElementById("hubDwell").value = "0.5";
  document.getElementById("hubMsg").textContent = "";
}

function fillHubForm(h){
  document.getElementById("hubId").value = h.id;
  document.getElementById("hubLat").value = Number(h.lat).toFixed(6);
  document.getElementById("hubLng").value = Number(h.lng).toFixed(6);
  document.getElementById("hubCountry").value = h.country;
  document.getElementById("hubCode").value = h.code;
  document.getElementById("hubNameRu").value = h.name_ru;
  document.getElementById("hubType").value = h.type || "hub";
  document.getElementById("hubDwell").value = String(h.dwell_days ?? 0.5);
}

async function saveHub(){
  const msg = document.getElementById("hubMsg");
  msg.textContent = "";
  try{
    const payload = {
      id: document.getElementById("hubId").value || undefined,
      country: document.getElementById("hubCountry").value,
      code: document.getElementById("hubCode").value,
      name_ru: document.getElementById("hubNameRu").value,
      type: document.getElementById("hubType").value,
      lat: document.getElementById("hubLat").value,
      lng: document.getElementById("hubLng").value,
      dwell_days: document.getElementById("hubDwell").value || 0.5
    };

    if (!payload.code || !payload.name_ru || payload.lat==="" || payload.lng==="") {
      throw new Error("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–¥, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã");
    }

    if (payload.id) {
      await api("/api/admin/hubs", { method:"PATCH", json: payload });
      msg.innerHTML = "<span class='ok'>–•–∞–± –æ–±–Ω–æ–≤–ª—ë–Ω</span>";
    } else {
      await api("/api/admin/hubs", { method:"POST", json: payload });
      msg.innerHTML = "<span class='ok'>–•–∞–± —Å–æ–∑–¥–∞–Ω</span>";
    }

    await loadAll();
    resetHubForm();
  }catch(e){
    msg.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

function resetCarForm(){
  document.getElementById("carId").value = "";
  document.getElementById("carVin").value = "";
  document.getElementById("carContract").value = "";
  document.getElementById("carBrand").value = "";
  document.getElementById("carModel").value = "";
  document.getElementById("carPhoto").value = "";
  document.getElementById("carUrgency").value = "std";
  document.getElementById("carStartTime").value = "";
  document.getElementById("carPublic").value = "true";
  document.getElementById("carMsg").textContent = "";

  // —Å–±—Ä–æ—Å –º–∞—Ä—à—Ä—É—Ç–∞
  editingRouteHubIds = [];
  renderRouteList();
}

function fillCarForm(c){
  document.getElementById("carId").value = c.id;
  document.getElementById("carVin").value = c.vin || "";
  document.getElementById("carContract").value = c.contract_no || "";
  document.getElementById("carBrand").value = c.brand || "";
  document.getElementById("carModel").value = c.model || "";
  document.getElementById("carPhoto").value = c.photo_url || "";
  document.getElementById("carUrgency").value = c.urgency || "std";
  document.getElementById("carStartTime").value = isoToLocalDatetime(c.start_time);
  document.getElementById("carPublic").value = String(!!c.public);

  editingRouteHubIds = Array.isArray(c.route_hub_ids) ? c.route_hub_ids.slice() : [];
  renderRouteList();

  // –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–∞—Ä—Ç/–∫–æ–Ω–µ—Ü –ø–æ —Ç–µ–∫—É—â–µ–º—É –º–∞—Ä—à—Ä—É—Ç—É
  const first = editingRouteHubIds[0];
  const last = editingRouteHubIds[editingRouteHubIds.length-1];
  if (first && hubsById.get(first)?.country === "CN") document.getElementById("carStartCN").value = first;
  if (last && hubsById.get(last)?.country === "RU") document.getElementById("carEndRU").value = last;
}

async function saveCar(){
  const msg = document.getElementById("carMsg");
  msg.textContent = "";
  try{
    const id = document.getElementById("carId").value || "";
    const start_time = parseLocalDatetimeToISO(document.getElementById("carStartTime").value);
    if (!start_time) throw new Error("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É/–≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞");

    // –º–∞—Ä—à—Ä—É—Ç –±–µ—Ä—ë–º –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    const route_hub_ids = editingRouteHubIds.filter(Boolean);
    if (route_hub_ids.length < 2) throw new Error("–ú–∞—Ä—à—Ä—É—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏ (—Å–æ–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é)");

    // –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞–Ω –Ω–∞ –∫—Ä–∞—è—Ö (–Ω–µ —Å—Ç—Ä–æ–≥–∞—è, –Ω–æ –ø–æ–ª–µ–∑–Ω–∞—è)
    const first = hubsById.get(route_hub_ids[0]);
    const last = hubsById.get(route_hub_ids[route_hub_ids.length-1]);
    if (!first || !last) throw new Error("–ú–∞—Ä—à—Ä—É—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ö–∞–±—ã (–æ–±–Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ)");
    if (first.country !== "CN") throw new Error("–ü–µ—Ä–≤–æ–π —Ç–æ—á–∫–æ–π –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ—á–∫–∞ –≤ –ö–∏—Ç–∞–µ (CN)");
    if (last.country !== "RU") throw new Error("–ü–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–æ–π –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ—á–∫–∞ –≤ –†–æ—Å—Å–∏–∏ (RU)");

    const payload = {
      id: id || undefined,
      vin: document.getElementById("carVin").value.trim(),
      contract_no: document.getElementById("carContract").value.trim(),
      brand: document.getElementById("carBrand").value.trim(),
      model: document.getElementById("carModel").value.trim(),
      photo_url: document.getElementById("carPhoto").value.trim(),
      urgency: document.getElementById("carUrgency").value,
      start_time,
      route_hub_ids,
      public: document.getElementById("carPublic").value === "true"
    };

    if (!payload.vin || !payload.contract_no) throw new Error("–ù—É–∂–Ω—ã VIN –∏ ‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞");

    if (id) {
      await api("/api/admin/cars", { method:"PATCH", json: payload });
      msg.innerHTML = "<span class='ok'>–ê–≤—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ</span>";
    } else {
      await api("/api/admin/cars", { method:"POST", json: payload });
      msg.innerHTML = "<span class='ok'>–ê–≤—Ç–æ —Å–æ–∑–¥–∞–Ω–æ</span>";
    }

    await loadAll();
    resetCarForm();
  }catch(e){
    msg.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

async function searchCars(){
  const q = document.getElementById("carSearch").value.trim();
  const out = document.getElementById("carsList");
  out.textContent = "";
  try{
    const r = await api("/api/admin/cars?q=" + encodeURIComponent(q));
    const list = r.cars || [];
    out.innerHTML = list.map(c => {
      return `<div class="listItem">
        <b>${(c.brand||"")} ${(c.model||"")}</b>
        <span class="pill">${c.urgency === "fast" ? "–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç"}</span>
        <br/>
        <span class="small">VIN: ${c.vin} | –î–æ–≥–æ–≤–æ—Ä: ${c.contract_no}</span><br/>
        <span class="small muted">public: ${c.public} | deleted: ${c.is_deleted}</span><br/>
        <div class="row" style="margin-top:6px">
          <button onclick="editCar('${c.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button onclick="togglePublic('${c.id}', ${!c.public})">${c.public ? "–°–∫—Ä—ã—Ç—å" : "–ü–æ–∫–∞–∑–∞—Ç—å"}</button>
          <button onclick="setDeleted('${c.id}', true)">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>`;
    }).join("");
    window.__carsSearchCache = list;
  }catch(e){
    out.innerHTML = "<span class='err'>"+e.message+"</span>";
  }
}

function editCar(id){
  const c = (window.__carsSearchCache || []).find(x=>x.id===id);
  if (!c) return;
  fillCarForm(c);
  showTab("cars");
}

async function togglePublic(id, val){
  await api("/api/admin/cars", { method:"PATCH", json:{ id, public: val } });
  await searchCars();
}

async function setDeleted(id, val){
  await api("/api/admin/cars", { method:"PATCH", json:{ id, is_deleted: val } });
  await searchCars();
}

/* ================= MAP RENDER ================= */
function renderHubsOnMap(){
  hubLayer.clearLayers();
  hubMarkersById.clear();

  for (const h of hubs) {
    if (typeof h.lat !== "number" || typeof h.lng !== "number") continue;

    const isActive = carsCache.some(c =>
      c.pos && haversineKm(c.pos, { lat:h.lat, lng:h.lng }) < ACTIVE_HUB_RADIUS_KM
    );

    const mk = L.marker([h.lat, h.lng], { icon: makeHubIcon(h, isActive) })
      .bindTooltip(
        `${h.name_ru || "–•–∞–±"} ‚Ä¢ ${hubTypeLabel(h.type)} ‚Ä¢ ${h.country}${isActive ? " ‚Ä¢ –∞–∫—Ç–∏–≤–Ω—ã–π" : ""}`,
        { direction:"top", offset:[0,-10] }
      );

    mk.on("click", () => {
      fillHubForm(h);
      showTab("hubs");
    });

    hubMarkersById.set(h.id, mk);
    hubLayer.addLayer(mk);
  }
}

function renderCarsOnMap(){
  carLayer.clearLayers();
  carMarkersById.clear();

  for (const c of carsCache) {
    if (!c.pos) continue;

    const mk = L.marker([c.pos.lat, c.pos.lng], { icon: makeCarIcon() })
      .bindPopup(`<b>${(c.brand||"")} ${(c.model||"")}</b><br/><span class="small">${c.status||""}</span>`);

    mk.on("click", () => {
      showTab("cars");
    });

    carMarkersById.set(c.id, mk);
    carLayer.addLayer(mk);
  }
}

/* ================= LOAD ALL ================= */
function fillBorderPairsSelect(){
  const sel = document.getElementById("carBorderPair");
  sel.innerHTML = "";
  sel.appendChild(option("", "‚Äî –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–∞—Ä—ã ‚Äî"));
  for (const p of BORDER_PAIRS) {
    sel.appendChild(option(p.id, p.name));
  }
}

function fillStartEndSelects(){
  const startSel = document.getElementById("carStartCN");
  const endSel = document.getElementById("carEndRU");
  startSel.innerHTML = "";
  endSel.innerHTML = "";

  const cn = allHubs.filter(x=>x.country==="CN");
  const ru = allHubs.filter(x=>x.country==="RU");

  // —Å—Ç–∞—Ä—Ç CN: –º–æ–∂–Ω–æ –∏ hub/service/office, border —Ç–æ–∂–µ –º–æ–∂–Ω–æ, –Ω–æ –ª—É—á—à–µ –∏—Å–∫–ª—é—á–∏—Ç—å
  for (const h of cn) startSel.appendChild(option(h.id, `${h.name_ru} [${h.code}] (${hubTypeLabel(h.type)})`));
  for (const h of ru) endSel.appendChild(option(h.id, `${h.name_ru} [${h.code}] (${hubTypeLabel(h.type)})`));
}

async function loadAll(){
  try {
    // 1) hubs from admin API
    const h = await api("/api/admin/hubs");
    hubs = h.hubs || [];
    allHubs = hubs.slice();
    hubsById = new Map(allHubs.map(x => [x.id, x]));
    document.getElementById("hubsList").textContent = "–•–∞–±–æ–≤: " + hubs.length;

    // 2) cars positions from public API (for active hubs)
    const pub = await fetch("/api/public?t=" + Date.now(), { cache:"no-store" }).then(r=>r.json());
    carsCache = (pub.cars || []).filter(x=>x.pos);

    // Fill selects
    fillRouteAddSelect();
    fillStartEndSelects();
    fillBorderPairsSelect();

    renderRouteList();
    renderHubsOnMap();
    renderCarsOnMap();
  } catch(e){
    alert(e.message + "\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å (ADMIN_PASS) –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.");
  }
}

loadAll();
setInterval(loadAll, 60_000);
</script>
</body>
</html>

