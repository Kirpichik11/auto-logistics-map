<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display: grid; grid-template-columns: 1fr 380px; height: 100vh; }
    #map { height: 100vh; }
    .side { border-left: 1px solid #eee; padding: 12px; overflow: auto; background:#fff; }

    .title { font-size: 16px; font-weight: 700; margin: 0 0 8px; }
    .sub { font-size: 12px; color: #666; margin: 0 0 12px; }

    .card { border: 1px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 10px; }

    .listCard { border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:10px; cursor:pointer; }
    .listCard:hover { background:#fafafa; }
    .listTop { display:flex; justify-content:space-between; gap:8px; }
    .listTitle { font-weight:700; font-size:13px; margin:0; }
    .badge { font-size:11px; padding:3px 8px; border-radius:999px; background:#f6f6f6; }
    .bar { height:6px; background:#eee; border-radius:999px; overflow:hidden; margin-top:6px; }
    .bar > div { height:100%; background:#111; }

    /* Icons */
    .carIcon {
      font-size: 18px;
      transform: translate(-6px, -10px);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
      user-select:none;
    }

    .hubIcon {
      font-size: 18px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#e0e0e0;
      border:2px solid #555;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
      user-select:none;
    }

    .hubIcon.active {
      background:#333;
      border-color:#000;
      color:#fff;
    }

    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; }
      .side { height: 45vh; }
      #map { height: 55vh; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map"></div>

  <div class="side">
    <p class="title">–ü–æ—Å—Ç–∞–≤–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</p>
    <p class="sub">–ü–æ–∑–∏—Ü–∏–∏ –∏ —Å—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>

    <div class="card">
      <div><b id="countCars">‚Äî</b> –∞–≤—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
    </div>

    <div id="carList"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_PUBLIC_URL = "/api/public";
const ACTIVE_HUB_RADIUS_KM = 10;

/* ================= MAP ================= */
const map = L.map('map').setView([50.5, 127.5], 4);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19,
  attribution: ''
}).addTo(map);

const cluster = L.markerClusterGroup();
map.addLayer(cluster);
const hubLayer = L.layerGroup().addTo(map);

let cars = [];
let hubs = [];
let markersByCarId = new Map();

/* ================= UTILS ================= */
function haversineKm(a, b) {
  const R = 6371;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(s));
}

function hubEmoji(type) {
  if (type === "border") return "üöß";
  if (type === "office") return "üè¢";
  return "üè≠";
}

/* ================= ICONS ================= */
function makeCarIcon() {
  return L.divIcon({
    html: `<div class="carIcon">üöó</div>`,
    className: "",
    iconSize: [18,18],
    iconAnchor: [9,9]
  });
}

function makeHubIcon(hub, active) {
  const emoji = hubEmoji(hub.type);
  const cls = active ? "hubIcon active" : "hubIcon";
  return L.divIcon({
    html: `<div class="${cls}">${emoji}</div>`,
    className: "",
    iconSize: [28,28],
    iconAnchor: [14,14]
  });
}

/* ================= RENDER HUBS ================= */
function renderHubs() {
  hubLayer.clearLayers();

  for (const h of hubs) {
    if (!h.lat || !h.lng) continue;

    const isActive = cars.some(c =>
      c.pos &&
      haversineKm(c.pos, { lat:h.lat, lng:h.lng }) < ACTIVE_HUB_RADIUS_KM
    );

    const mk = L.marker([h.lat, h.lng], {
      icon: makeHubIcon(h, isActive)
    }).bindTooltip(h.name_ru || "–•–∞–±", { direction:"top", offset:[0,-10] });

    hubLayer.addLayer(mk);
  }
}

/* ================= MARKERS ================= */
function upsertMarkers() {
  const ids = new Set(cars.map(c => c.id));

  for (const [id, mk] of markersByCarId) {
    if (!ids.has(id)) {
      cluster.removeLayer(mk);
      markersByCarId.delete(id);
    }
  }

  for (const car of cars) {
    if (!car.pos) continue;

    let marker = markersByCarId.get(car.id);
    if (!marker) {
      marker = L.marker([car.pos.lat, car.pos.lng], { icon: makeCarIcon() });
      cluster.addLayer(marker);
      markersByCarId.set(car.id, marker);
    } else {
      marker.setLatLng([car.pos.lat, car.pos.lng]);
    }
  }

  document.getElementById("countCars").textContent = cars.length;
}

/* ================= LIST ================= */
function renderCarList() {
  const el = document.getElementById("carList");
  el.innerHTML = cars.map(c => `
    <div class="listCard">
      <div class="listTop">
        <p class="listTitle">${c.brand || ""} ${c.model || ""}</p>
        <span class="badge">${c.urgency === "fast" ? "–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç"}</span>
      </div>
      <div class="bar"><div style="width:${Math.round((c.progress||0)*100)}%"></div></div>
    </div>
  `).join("");
}

/* ================= DATA ================= */
async function loadData() {
  const r = await fetch(WORKER_PUBLIC_URL, { cache:"no-store" });
  const data = await r.json();

  hubs = data.hubs || [];
  cars = (data.cars || []).filter(c => c.pos);

  upsertMarkers();
  renderHubs();
  renderCarList();
}

loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>

