<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display:grid; grid-template-columns: 1fr 420px; height:100vh; }
    #map { height:100vh; }
    .side { border-left:1px solid #eee; padding:12px; overflow:auto; background:#fff; }
    .title { font-size:16px; font-weight:700; margin:0 0 8px; }
    .sub { font-size:12px; color:#666; margin:0 0 12px; }

    .card { border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:10px; }
    .row { display:flex; gap:10px; align-items:center; }
    input { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; }
    button { padding:10px 12px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer; }
    .hint { font-size:12px; color:#777; margin-top:6px; }
    .small { font-size:12px; color:#666; }
    .ok { color:#0a7; }
    .err { color:#d33; }

    .listCard { border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:10px; cursor:pointer; }
    .listCard:hover { background:#fafafa; }
    .listCard.active { outline:2px solid #111; background:#fbfbfb; }
    .listTop { display:flex; justify-content:space-between; gap:10px; }
    .listTitle { font-weight:700; font-size:13px; margin:0; }
    .badge { font-size:11px; padding:3px 8px; border-radius:999px; background:#f6f6f6; white-space:nowrap; }
    .bar { height:6px; background:#eee; border-radius:999px; overflow:hidden; margin-top:8px; }
    .bar > div { height:100%; background:#111; border-radius:999px; }
    .listMeta { font-size:12px; color:#666; margin-top:6px; display:flex; justify-content:space-between; gap:10px; }

    .detailsInline {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #eee;
      display: grid;
      grid-template-columns: 88px 1fr;
      gap: 10px;
    }
    .detailsLine { font-size:12px; color:#666; margin-top:4px; }
    .img { width:88px; height:66px; border-radius:10px; background:#f3f3f3; object-fit:cover; }

    .carEmoji {
      font-size: 24px;
      line-height: 1;
      user-select:none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.25);
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      will-change: transform;
    }

    .hubEmoji {
      display:block;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      will-change: transform;
    }

    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; }
      .side { height: 45vh; }
      #map { height: 55vh; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div id="map"></div>

  <div class="side">
    <p class="title">–ü–æ—Å—Ç–∞–≤–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</p>
    <p class="sub">–ö–∞—Ä—Ç–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è. –°—Ç–∞—Ç—É—Å—ã –∏ –ø–æ–∑–∏—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>

    <div class="card">
      <b>–ü–æ–∏—Å–∫ –∞–≤—Ç–æ</b>
      <div class="hint">–í–≤–µ–¥–∏—Ç–µ VIN –∏–ª–∏ ‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞ (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤).</div>
      <div class="row" style="margin-top:8px">
        <input id="searchInput" placeholder="VIN –∏–ª–∏ ‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞" />
        <button id="searchBtn">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="searchMsg" class="small"></div>
    </div>

    <div class="card">
      <div><b id="countCars">‚Äî</b> –∞–≤—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
      <div class="hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–≤—Ç–æ –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.</div>
      <div class="hint">–ú–∞—Ä—à—Ä—É—Ç –ª–∏–Ω–∏–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞ –ø–æ VIN/–¥–æ–≥–æ–≤–æ—Ä—É.</div>
      <div class="hint">–ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–µ ‚Äî —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –∏ —Å–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π.</div>
    </div>

    <div id="carList"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_PUBLIC_URL = "/api/public";
const SEARCH_URL = "/api/search?q=";
const REFRESH_DATA_MS = 60_000;
const ACTIVE_HUB_RADIUS_KM = 10;

/* ================= UTILS ================= */
function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}
function fmtEta(isoArrive) {
  if (!isoArrive) return "‚Äî";
  const t = Date.parse(isoArrive);
  if (!t) return "‚Äî";
  const diff = t - Date.now();
  if (diff <= 0) return "—Å–µ–π—á–∞—Å";
  const hours = diff / 3600000;
  if (hours < 24) return `${Math.round(hours)} —á`;
  const days = hours / 24;
  return `${days.toFixed(1)} –¥–Ω`;
}
function fmtDate(iso) {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleString("ru-RU");
}
function urgencyText(u) {
  return u === "fast" ? "–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç";
}
function haversineKm(a, b) {
  const R = 6371;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(s));
}

/* ================= HUB LABELS ================= */
function hubEmoji(type) {
  if (type === "border") return "üöß";
  if (type === "office") return "üè¢";
  if (type === "service") return "üè™";
  return "üè≠";
}
function hubTypeLabel(type) {
  if (type === "border") return "–ì—Ä–∞–Ω–∏—Ü–∞";
  if (type === "office") return "–û—Ñ–∏—Å";
  if (type === "service") return "–°–µ—Ä–≤–∏—Å/–í—ã–¥–∞—á–∞";
  return "–õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ö–∞–±";
}
function buildHubInfoHtml(h, isActive) {
  const name = escapeHtml(h.name_ru || "–ü—É–Ω–∫—Ç");
  const type = escapeHtml(hubTypeLabel(h.type));
  const country = escapeHtml(h.country || "");
  const code = escapeHtml(h.code || "");
  const active = isActive ? `<div class="small"><b>–ê–∫—Ç–∏–≤–Ω—ã–π</b>: —Ä—è–¥–æ–º –µ—Å—Ç—å –∞–≤—Ç–æ</div>` : "";
  return `
    <div style="min-width:180px">
      <div style="font-weight:700">${name}</div>
      <div class="small">–¢–∏–ø: ${type}</div>
      ${country ? `<div class="small">–°—Ç—Ä–∞–Ω–∞: ${country}</div>` : ""}
      ${code ? `<div class="small">–ö–æ–¥: ${code}</div>` : ""}
      ${active}
    </div>
  `;
}

/* ================= MAP INIT ================= */
const map = L.map('map', { preferCanvas:true, attributionControl: false }).setView([50.5, 127.5], 4);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19, attribution: ''
}).addTo(map);

L.control.attribution({ position: "bottomright", prefix: false })
  .addAttribution('&copy; OpenStreetMap contributors &copy; CARTO')
  .addTo(map);

// –ü–æ—Ä—è–¥–æ–∫ —Å–ª–æ—ë–≤: –ª–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∏–∂–µ —Ö–∞–±–æ–≤, –º–∞—à–∏–Ω—ã –≤—ã—à–µ –≤—Å–µ–≥–æ
map.createPane("routePane");
map.getPane("routePane").style.zIndex = 405;

map.createPane("hubPane");
map.getPane("hubPane").style.zIndex = 410;

map.createPane("carPane");
map.getPane("carPane").style.zIndex = 420;

// –ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–µ ‚Äî —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
map.on("click", () => {
  selectCarById(null);
  map.closePopup();
});

const cluster = L.markerClusterGroup();
map.addLayer(cluster);

const hubLayer = L.layerGroup().addTo(map);

/* ================= STATE ================= */
let cars = [];
let hubs = [];
let hubsById = new Map();

let markersByCarId = new Map();
let selectedCarId = null;

// –ú–∞—Ä—à—Ä—É—Ç –ª–∏–Ω–∏–µ–π ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞
let searchedCarId = null;
let routeLine = null;
let routeByCarId = new Map(); // carId -> array of hub points with lat/lng

/* ================= ROUTE LINE ================= */
function clearRouteLine() {
  if (routeLine) {
    map.removeLayer(routeLine);
    routeLine = null;
  }
}

function drawRouteLine(points) {
  clearRouteLine();

  if (!Array.isArray(points) || points.length < 2) {
    console.log("ROUTE: no points or too short", points);
    return;
  }

  const latlngs = points
    .map(p => [Number(p.lat), Number(p.lng)])
    .filter(x => Number.isFinite(x[0]) && Number.isFinite(x[1]));

  if (latlngs.length < 2) {
    console.log("ROUTE: latlngs too short after filtering", latlngs);
    return;
  }

  // –î–µ–ª–∞–µ–º –ª–∏–Ω–∏—é –∑–∞–º–µ—Ç–Ω–æ–π
  routeLine = L.polyline(latlngs, {
    pane: "routePane",
    color: "#111",
    weight: 6,
    opacity: 0.95
  }).addTo(map);

  console.log("ROUTE LINE DRAWN:", latlngs.length, "points", latlngs);
}

/* ================= ICONS ================= */
function makeCarIcon(isSelected) {
  const size = isSelected ? 26 : 24;
  const html = `<span class="carEmoji" style="font-size:${size}px">üöó</span>`;
  return L.divIcon({ html, className:"", iconSize:[30,30], iconAnchor:[15,15] });
}

function makeHubIcon(hub, active) {
  let size = 26;
  let bgColor = "#6c757d";

  if (hub.type === "service") { size = 20; bgColor = "#28a745"; }
  if (hub.type === "border")  { size = 24; bgColor = "#f4c542"; }
  if (hub.type === "office")  { size = 22; bgColor = "#007bff"; }

  const emoji = hubEmoji(hub.type);
  const ring = active ? "rgba(0,0,0,0.9)" : "rgba(0,0,0,0.35)";

  const html = `
    <div style="
      width:${size}px;height:${size}px;border-radius:50%;
      background:${bgColor};
      display:flex;align-items:center;justify-content:center;
      font-size:${Math.max(11, Math.round(size*0.55))}px;
      border:2px solid ${ring};
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
    "><span class="hubEmoji">${emoji}</span></div>
  `;

  return L.divIcon({ html, className:"", iconSize:[size,size], iconAnchor:[size/2,size/2] });
}

/* ================= SELECT ================= */
function selectCarById(id) {
  selectedCarId = id || null;

  renderCarList();
  upsertMarkers();

  // –õ–∏–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω–æ–π –ø–æ–∏—Å–∫–æ–º –º–∞—à–∏–Ω—ã
  if (!selectedCarId || selectedCarId !== searchedCarId) {
    clearRouteLine();
  } else {
    drawRouteLine(routeByCarId.get(selectedCarId));
  }

  if (!selectedCarId) {
    return;
  }

  const car = cars.find(c => c.id === selectedCarId);
  if (!car || !car.pos) return;

  map.setView([car.pos.lat, car.pos.lng], Math.max(map.getZoom(), 6), { animate:true });

  const mk = markersByCarId.get(car.id);
  if (mk) mk.openPopup();
}

/* ================= LIST ================= */
function renderCarList() {
  const el = document.getElementById("carList");

  const list = [...cars].sort((a,b) => {
    if (a.id === selectedCarId) return -1;
    if (b.id === selectedCarId) return 1;
    return (b.progress ?? 0) - (a.progress ?? 0);
  });

  el.innerHTML = list.map(car => {
    const title = `${car.brand || ""} ${car.model || ""}`.trim() || "–ê–≤—Ç–æ–º–æ–±–∏–ª—å";
    const pct = Math.round((car.progress ?? 0) * 100);
    const eta = fmtEta(car.arrive_time);
    const badge = urgencyText(car.urgency);
    const active = car.id === selectedCarId;

    const activeCls = active ? "listCard active" : "listCard";

    const inlineDetails = active ? `
      <div class="detailsInline">
        ${car.photo_url ? `<img class="img" src="${car.photo_url}" alt="auto" />` : `<div class="img"></div>`}
        <div>
          <div class="detailsLine"><span class="hint" style="margin:0">–°—Ä–æ—á–Ω–æ—Å—Ç—å:</span> ${escapeHtml(urgencyText(car.urgency))}</div>
          <div class="detailsLine"><span class="hint" style="margin:0">–°—Ç–∞—Ç—É—Å:</span> ${escapeHtml(car.status || "‚Äî")}</div>
          <div class="detailsLine"><span class="hint" style="margin:0">–û—Å—Ç–∞–ª–æ—Å—å:</span> ${escapeHtml(fmtEta(car.arrive_time))}</div>
          <div class="detailsLine"><span class="hint" style="margin:0">–ü—Ä–∏–±—ã—Ç–∏–µ:</span> ${escapeHtml(fmtDate(car.arrive_time))}</div>
          <div class="bar" style="margin-top:10px"><div style="width:${pct}%"></div></div>
          <div class="detailsLine">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${pct}%</div>
        </div>
      </div>
    ` : ``;

    return `
      <div class="${activeCls}" data-id="${car.id}">
        <div class="listTop">
          <p class="listTitle">${escapeHtml(title)}</p>
          <span class="badge">${escapeHtml(badge)}</span>
        </div>
        <div class="bar"><div style="width:${pct}%"></div></div>
        <div class="listMeta">
          <span>${escapeHtml(car.status || "‚Äî")}</span>
          <span>ETA: ${escapeHtml(eta)}</span>
        </div>
        ${inlineDetails}
      </div>
    `;
  }).join("");

  for (const node of el.querySelectorAll(".listCard")) {
    node.addEventListener("click", () => {
      const id = node.getAttribute("data-id");
      if (id === selectedCarId) selectCarById(null);
      else selectCarById(id);
    });
  }

  document.getElementById("countCars").textContent = String(cars.length);

  if (selectedCarId) {
    const activeNode = el.querySelector(`.listCard[data-id="${selectedCarId}"]`);
    if (activeNode) activeNode.scrollIntoView({ block: "nearest", behavior: "smooth" });
  }
}

/* ================= HUBS ================= */
function renderHubs() {
  hubLayer.clearLayers();

  for (const h of hubs) {
    if (typeof h.lat !== "number" || typeof h.lng !== "number") continue;

    const isActive = cars.some(c =>
      c.pos && haversineKm(c.pos, { lat:h.lat, lng:h.lng }) < ACTIVE_HUB_RADIUS_KM
    );

    const mk = L.marker([h.lat, h.lng], {
      icon: makeHubIcon(h, isActive),
      pane: "hubPane"
    });

    mk.bindTooltip(
      `${escapeHtml(h.name_ru || "–ü—É–Ω–∫—Ç")} ‚Ä¢ ${escapeHtml(hubTypeLabel(h.type))}`,
      { direction:"top", offset:[0,-10], sticky:true, opacity:0.95 }
    );

    mk.bindPopup(buildHubInfoHtml(h, isActive), { closeButton:true });

    mk.on("click", (e) => {
      if (e?.originalEvent) e.originalEvent.stopPropagation();
      mk.openPopup();
    });

    hubLayer.addLayer(mk);
  }
}

/* ================= MARKERS ================= */
function buildPopup(car) {
  const title = `${car.brand || ""} ${car.model || ""}`.trim() || "–ê–≤—Ç–æ–º–æ–±–∏–ª—å";
  return `
    <b>${escapeHtml(title)}</b><br/>
    <span style="font-size:12px;color:#666">–°—Ç–∞—Ç—É—Å: ${escapeHtml(car.status || "‚Äî")}</span>
  `;
}

function upsertMarkers() {
  const ids = new Set(cars.map(c => c.id));
  for (const [id, mk] of markersByCarId.entries()) {
    if (!ids.has(id)) {
      cluster.removeLayer(mk);
      markersByCarId.delete(id);
    }
  }

  for (const car of cars) {
    if (!car.pos || typeof car.pos.lat !== "number" || typeof car.pos.lng !== "number") continue;

    const isSel = car.id === selectedCarId;
    let marker = markersByCarId.get(car.id);

    if (!marker) {
      marker = L.marker([car.pos.lat, car.pos.lng], {
        icon: makeCarIcon(isSel),
        pane: "carPane"
      });

      marker.bindPopup(buildPopup(car));

      marker.on("click", (e) => {
        if (e?.originalEvent) e.originalEvent.stopPropagation();
        selectCarById(car.id);
      });

      markersByCarId.set(car.id, marker);
      cluster.addLayer(marker);
    } else {
      marker.setLatLng([car.pos.lat, car.pos.lng]);
      marker.setIcon(makeCarIcon(isSel));
      marker.setPopupContent(buildPopup(car));
    }
  }
}

/* ================= DATA ================= */
async function loadData() {
  const resp = await fetch(WORKER_PUBLIC_URL + "?t=" + Date.now(), { cache:"no-store" });
  const data = await resp.json();

  hubs = (data.hubs || []);
  hubsById = new Map(hubs.map(h => [h.id, h]));

  cars = (data.cars || []).filter(c => c.pos && typeof c.pos.lat === "number");

  renderHubs();
  upsertMarkers();
  renderCarList();

  if (selectedCarId && !cars.some(c => c.id === selectedCarId)) {
    selectedCarId = null;
    renderCarList();
    upsertMarkers();
    clearRouteLine();
  }
}

/* ================= SEARCH ================= */
async function doSearch() {
  const input = document.getElementById("searchInput");
  const msg = document.getElementById("searchMsg");
  const q = String(input.value || "").trim();
  msg.textContent = "";

  if (q.length < 6) {
    msg.innerHTML = `<span class="err">–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</span>`;
    return;
  }

  try {
    // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ hubs —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if (!hubsById || hubsById.size === 0) {
      await loadData();
    }

    const r = await fetch(SEARCH_URL + encodeURIComponent(q) + "&t=" + Date.now(), { cache:"no-store" });
    const data = await r.json();
    if (!r.ok) throw new Error(data.error || "–ù–µ –Ω–∞–π–¥–µ–Ω–æ");

    const found = data.car;

    // —Ä–∞–∑—Ä–µ—à–∞–µ–º –ª–∏–Ω–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω—ã
    searchedCarId = found.id;

    // –æ–±–Ω–æ–≤–ª—è–µ–º/–¥–æ–±–∞–≤–ª—è–µ–º –º–∞—à–∏–Ω—É –≤ —Å–ø–∏—Å–æ–∫
    const idx = cars.findIndex(c => c.id === found.id);
    if (idx === -1) cars.unshift(found);
    else cars[idx] = found;

    // —Å–æ–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
    let routePoints = null;

    if (Array.isArray(found.route) && found.route.length >= 2) {
      routePoints = found.route;
      console.log("ROUTE: using found.route", routePoints.length);
    } else if (Array.isArray(found.route_hub_ids) && found.route_hub_ids.length >= 2) {
      const missing = [];
      routePoints = found.route_hub_ids
        .map(id => {
          const h = hubsById.get(id);
          if (!h) missing.push(id);
          return h;
        })
        .filter(Boolean);

      console.log("ROUTE: from route_hub_ids",
        "ids=", found.route_hub_ids.length,
        "points=", routePoints.length,
        "missing=", missing.length,
        missing
      );
    } else {
      console.log("ROUTE: no route and no route_hub_ids", found);
    }

    if (Array.isArray(routePoints) && routePoints.length >= 2) {
      routeByCarId.set(found.id, routePoints);
      msg.innerHTML = `<span class="ok">–ù–∞–π–¥–µ–Ω–æ</span>`;
    } else {
      routeByCarId.delete(found.id);
      clearRouteLine();
      msg.innerHTML = `<span class="ok">–ù–∞–π–¥–µ–Ω–æ</span> <span class="err">(–º–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–º. –∫–æ–Ω—Å–æ–ª—å F12)</span>`;
    }

    // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ UI
    renderHubs();
    upsertMarkers();
    renderCarList();

    // –≤—ã–±–∏—Ä–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—É—é
    selectCarById(found.id);

    // ‚úÖ –í–ê–ñ–ù–û: —Ä–∏—Å—É–µ–º –ª–∏–Ω–∏—é –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞
    const pts = routeByCarId.get(found.id);
    drawRouteLine(pts);

    // –∏ –ø—Ä–∏–±–ª–∏–∑–∏–º –∫–∞—Ä—Ç—É –∫ –ª–∏–Ω–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if (routeLine) {
      try { map.fitBounds(routeLine.getBounds(), { padding: [30, 30] }); } catch {}
    }

  } catch (e) {
    msg.innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
  }
}
document.getElementById("searchBtn").addEventListener("click", doSearch);
document.getElementById("searchInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter") doSearch();
});

/* ================= START ================= */
(async function start(){
  try {
    await loadData();
  } catch(e) {
    console.error("INIT ERROR", e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏.");
    return;
  }
  setInterval(() => loadData().catch(console.error), REFRESH_DATA_MS);
})();
</script>
</body>
</html>
