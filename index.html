<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster (2 CSS + 1 JS) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display:grid; grid-template-columns: 1fr 420px; height:100vh; }
    #map { height:100vh; }
    .side { border-left:1px solid #eee; padding:12px; overflow:auto; background:#fff; }
    .title { font-size:16px; font-weight:700; margin:0 0 8px; }
    .sub { font-size:12px; color:#666; margin:0 0 12px; }

    .card { border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:10px; }
    .row { display:flex; gap:10px; align-items:center; }
    input { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; }
    button { padding:10px 12px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer; }
    .hint { font-size:12px; color:#777; margin-top:6px; }
    .small { font-size:12px; color:#666; }
    .ok { color:#0a7; }
    .err { color:#d33; }

    /* List */
    .listCard { border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:10px; cursor:pointer; }
    .listCard:hover { background:#fafafa; }
    .listCard.active { outline:2px solid #111; background:#fbfbfb; }
    .listTop { display:flex; justify-content:space-between; gap:10px; }
    .listTitle { font-weight:700; font-size:13px; margin:0; }
    .badge { font-size:11px; padding:3px 8px; border-radius:999px; background:#f6f6f6; white-space:nowrap; }
    .bar { height:6px; background:#eee; border-radius:999px; overflow:hidden; margin-top:8px; }
    .bar > div { height:100%; background:#111; border-radius:999px; }
    .listMeta { font-size:12px; color:#666; margin-top:6px; display:flex; justify-content:space-between; gap:10px; }

    /* –ú–∞—à–∏–Ω–∞: –ë–ï–ó –∫—Ä—É–≥–∞, –ø—Ä–æ—Å—Ç–æ —ç–º–æ–¥–∑–∏ */
    .carEmoji {
      font-size: 24px;
      line-height: 1;
      user-select:none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.25);
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      will-change: transform;
    }

    .img { width:88px; height:66px; border-radius:10px; background:#f3f3f3; object-fit:cover; }

    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; }
      .side { height: 45vh; }
      #map { height: 55vh; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div id="map"></div>

  <div class="side">
    <p class="title">–ü–æ—Å—Ç–∞–≤–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</p>
    <p class="sub">–ö–∞—Ä—Ç–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è. –°—Ç–∞—Ç—É—Å—ã –∏ –ø–æ–∑–∏—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>

    <!-- SEARCH -->
    <div class="card">
      <b>–ü–æ–∏—Å–∫ –∞–≤—Ç–æ</b>
      <div class="hint">–í–≤–µ–¥–∏—Ç–µ VIN –∏–ª–∏ ‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞ (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤).</div>
      <div class="row" style="margin-top:8px">
        <input id="searchInput" placeholder="VIN –∏–ª–∏ ‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞" />
        <button id="searchBtn">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="searchMsg" class="small"></div>
    </div>

    <!-- SUMMARY -->
    <div class="card">
      <div><b id="countCars">‚Äî</b> –∞–≤—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
      <div class="hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–≤—Ç–æ –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.</div>
      <div class="hint">–ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–µ ‚Äî —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –∏ —Å–∫—Ä—ã—Ç–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞.</div>
    </div>

    <div id="carList"></div>
    <div id="details"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_PUBLIC_URL = "/api/public";
const SEARCH_URL = "/api/search?q=";
const REFRESH_DATA_MS = 60_000;
const ACTIVE_HUB_RADIUS_KM = 10;

/* ================= MAP ================= */
const map = L.map('map', { preferCanvas:true, attributionControl: false }).setView([50.5, 127.5], 4);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19, attribution: ''
}).addTo(map);

L.control.attribution({ position: "bottomright", prefix: false })
  .addAttribution('&copy; OpenStreetMap contributors &copy; CARTO')
  .addTo(map);

/**
 * Pane'—ã (–≤–∞–∂–µ–Ω –ø–æ—Ä—è–¥–æ–∫):
 * - hubPane: –æ–±—ã—á–Ω—ã–µ —Ö–∞–±—ã (–∏—Ö –ª–∏–Ω–∏—è –ú–û–ñ–ï–¢ –ø–µ—Ä–µ–∫—Ä—ã—Ç—å)
 * - routePane: –ª–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
 * - routeHubPane: –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (–≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö –ª–∏–Ω–∏–∏)
 * - carPane: –∞–≤—Ç–æ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
 */
map.createPane("hubPane");
map.getPane("hubPane").style.zIndex = 390;

map.createPane("routePane");
map.getPane("routePane").style.zIndex = 400;

map.createPane("routeHubPane");
map.getPane("routeHubPane").style.zIndex = 410;

map.createPane("carPane");
map.getPane("carPane").style.zIndex = 450;

// –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –º–∞—à–∏–Ω
const cluster = L.markerClusterGroup();
map.addLayer(cluster);

// —Å–ª–æ–π —Ö–∞–±–æ–≤ (–æ–±—ã—á–Ω—ã–µ)
const hubLayer = L.layerGroup([], { pane: "hubPane" }).addTo(map);

// —Å–ª–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Ö–∞–±–æ–≤ –º–∞—Ä—à—Ä—É—Ç–∞ (–ø–æ–≤–µ—Ä—Ö –ª–∏–Ω–∏–∏)
const routeHubLayer = L.layerGroup([], { pane: "routeHubPane" }).addTo(map);

// –ª–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
let routePolyline = null;

let cars = [];
let hubs = [];
let hubsById = new Map();

let markersByCarId = new Map();
let selectedCarId = null;

/* ================= UTILS ================= */
function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}
function fmtEta(isoArrive) {
  if (!isoArrive) return "‚Äî";
  const t = Date.parse(isoArrive);
  if (!t) return "‚Äî";
  const diff = t - Date.now();
  if (diff <= 0) return "—Å–µ–π—á–∞—Å";
  const hours = diff / 3600000;
  if (hours < 24) return `${Math.round(hours)} —á`;
  const days = hours / 24;
  return `${days.toFixed(1)} –¥–Ω`;
}
function fmtDate(iso) {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleString("ru-RU");
}
function urgencyText(u) {
  return u === "fast" ? "–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç";
}
function haversineKm(a, b) {
  const R = 6371;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(s));
}
function hubEmoji(type) {
  if (type === "border") return "üöß";
  if (type === "office") return "üè¢";
  if (type === "service") return "üè™";
  return "üè≠"; // hub
}
function clamp01(x) { return Math.max(0, Math.min(1, x)); }
function lerpLatLng(a, b, t) {
  return { lat: a.lat + (b.lat - a.lat) * t, lng: a.lng + (b.lng - a.lng) * t };
}

/* ================= ICONS ================= */
function makeCarIcon(isSelected) {
  const size = isSelected ? 26 : 24;
  const html = `<span class="carEmoji" style="font-size:${size}px">üöó</span>`;
  return L.divIcon({ html, className:"", iconSize:[30,30], iconAnchor:[15,15] });
}

function makeHubIcon(hub, active) {
  let size = 26;
  let bgColor = "#6c757d"; // hub

  if (hub.type === "service") {
    size = 20;
    bgColor = "#28a745"; // –∑–µ–ª—ë–Ω—ã–π
  }
  if (hub.type === "border") {
    size = 24;
    bgColor = "#f4c542"; // –∂—ë–ª—Ç—ã–π
  }
  if (hub.type === "office") {
    size = 22;
    bgColor = "#007bff"; // —Å–∏–Ω–∏–π
  }

  // active –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (–ª—ë–≥–∫–∞—è)
  const ring = active ? "0 0 0 3px rgba(0,0,0,0.25) inset" : "none";
  const emoji = hubEmoji(hub.type);

  const html = `
    <div style="
      width:${size}px;
      height:${size}px;
      border-radius:50%;
      background:${bgColor};
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:${size * 0.5}px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
      ${active ? `outline:2px solid rgba(0,0,0,0.45); outline-offset:0;` : ``}
    ">
      ${emoji}
    </div>
  `;

  return L.divIcon({
    html,
    className:"",
    iconSize:[size,size],
    iconAnchor:[size/2,size/2]
  });
}

/* ================= ROUTE (LINE + CONTROL POINTS) ================= */
function clearRoute() {
  if (routePolyline) {
    routePolyline.remove();
    routePolyline = null;
  }
  routeHubLayer.clearLayers();
}

function buildRouteLatLngs(car) {
  const ids = Array.isArray(car?.route_hub_ids) ? car.route_hub_ids : [];
  const latlngs = [];
  for (const id of ids) {
    const h = hubsById.get(id);
    if (!h) continue;
    if (typeof h.lat !== "number" || typeof h.lng !== "number") continue;
    latlngs.push([h.lat, h.lng]);
  }
  return latlngs;
}

function isHubActive(h) {
  return cars.some(c =>
    c.pos && haversineKm(c.pos, { lat:h.lat, lng:h.lng }) < ACTIVE_HUB_RADIUS_KM
  );
}

function showRouteForCar(car) {
  clearRoute();

  const ids = Array.isArray(car?.route_hub_ids) ? car.route_hub_ids : [];
  const routeSet = new Set(ids);

  // –ª–∏–Ω–∏—è
  const latlngs = buildRouteLatLngs(car);
  if (latlngs.length >= 2) {
    routePolyline = L.polyline(latlngs, {
      pane: "routePane",
      weight: 3,
      opacity: 0.9,
      lineCap: "round",
      lineJoin: "round",
      interactive: false
    }).addTo(map);
  }

  // –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ö–∞–±—ã –º–∞—Ä—à—Ä—É—Ç–∞ (–ø–æ–≤–µ—Ä—Ö –ª–∏–Ω–∏–∏)
  for (const id of routeSet) {
    const h = hubsById.get(id);
    if (!h) continue;

    const mk = L.marker([h.lat, h.lng], {
      icon: makeHubIcon(h, isHubActive(h)),
      pane: "routeHubPane"
    }).bindTooltip(
      `${escapeHtml(h.name_ru || "–•–∞–±")} ‚Ä¢ –º–∞—Ä—à—Ä—É—Ç`,
      { direction:"top", offset:[0,-10] }
    );

    routeHubLayer.addLayer(mk);
  }

  return routeSet;
}

/* ================= UI ================= */
function showCarDetails(car) {
  const el = document.getElementById("details");
  const title = `${car.brand || ""} ${car.model || ""}`.trim() || "–ê–≤—Ç–æ–º–æ–±–∏–ª—å";
  const pct = Math.round(((car.progress ?? 0) * 100));

  el.innerHTML = `
    <div class="card">
      <div class="row" style="align-items:flex-start">
        ${car.photo_url ? `<img class="img" src="${car.photo_url}" alt="auto" />` : `<div class="img"></div>`}
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(title)}</div>
          <div class="small"><span class="hint" style="margin:0">–°—Ä–æ—á–Ω–æ—Å—Ç—å:</span> ${escapeHtml(urgencyText(car.urgency))}</div>
          <div class="small"><span class="hint" style="margin:0">–°—Ç–∞—Ç—É—Å:</span> ${escapeHtml(car.status || "‚Äî")}</div>
          <div class="small"><span class="hint" style="margin:0">–û—Å—Ç–∞–ª–æ—Å—å:</span> ${escapeHtml(fmtEta(car.arrive_time))}</div>
          <div class="small"><span class="hint" style="margin:0">–ü—Ä–∏–±—ã—Ç–∏–µ:</span> ${escapeHtml(fmtDate(car.arrive_time))}</div>
        </div>
      </div>
      <div class="bar" style="margin-top:10px"><div style="width:${pct}%"></div></div>
      <div class="small" style="margin-top:6px">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${pct}%</div>
      <div class="hint" style="margin-top:8px">–ú–∞—Ä—à—Ä—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ.</div>
    </div>
  `;
}

function selectCarById(id) {
  selectedCarId = id || null;

  renderCarList();
  upsertMarkers();

  // –µ—Å–ª–∏ —Å–Ω—è–ª–∏ –≤—ã–±–æ—Ä ‚Äî —Å–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç –∏ –¥–µ—Ç–∞–ª–∏
  if (!selectedCarId) {
    clearRoute();
    document.getElementById("details").innerHTML = "";
    renderHubs(null);
    return;
  }

  const car = cars.find(c => c.id === selectedCarId);
  if (!car || !car.pos) return;

  map.setView([car.pos.lat, car.pos.lng], Math.max(map.getZoom(), 6), { animate:true });

  const mk = markersByCarId.get(car.id);
  if (mk) mk.openPopup();

  showCarDetails(car);

  // –ø–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –¢–û–õ–¨–ö–û –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ
  const routeSet = showRouteForCar(car);
  renderHubs(routeSet);
}

/* –ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–µ ‚Äî —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ */
map.on("click", () => {
  if (selectedCarId) selectCarById(null);
});

/* ================= LIST ================= */
function renderCarList() {
  const el = document.getElementById("carList");

  const list = [...cars].sort((a,b) => {
    if (a.id === selectedCarId) return -1;
    if (b.id === selectedCarId) return 1;
    return (b.progress ?? 0) - (a.progress ?? 0);
  });

  el.innerHTML = list.map(car => {
    const title = `${car.brand || ""} ${car.model || ""}`.trim() || "–ê–≤—Ç–æ–º–æ–±–∏–ª—å";
    const pct = Math.round((car.progress ?? 0) * 100);
    const eta = fmtEta(car.arrive_time);
    const badge = urgencyText(car.urgency);
    const activeCls = car.id === selectedCarId ? "listCard active" : "listCard";

    return `
      <div class="${activeCls}" data-id="${car.id}">
        <div class="listTop">
          <p class="listTitle">${escapeHtml(title)}</p>
          <span class="badge">${escapeHtml(badge)}</span>
        </div>
        <div class="bar"><div style="width:${pct}%"></div></div>
        <div class="listMeta">
          <span>${escapeHtml(car.status || "‚Äî")}</span>
          <span>ETA: ${escapeHtml(eta)}</span>
        </div>
      </div>
    `;
  }).join("");

  for (const node of el.querySelectorAll(".listCard")) {
    node.addEventListener("click", () => {
      selectCarById(node.getAttribute("data-id"));
    });
  }

  document.getElementById("countCars").textContent = String(cars.length);
}

/* ================= HUBS ================= */
function renderHubs(routeSet) {
  hubLayer.clearLayers();

  for (const h of hubs) {
    if (typeof h.lat !== "number" || typeof h.lng !== "number") continue;

    // –µ—Å–ª–∏ —Ö–∞–± –≤—Ö–æ–¥–∏—Ç –≤ –º–∞—Ä—à—Ä—É—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ ‚Äî –ù–ï —Ä–∏—Å—É–µ–º –µ–≥–æ —Ç—É—Ç
    // –æ–Ω –±—É–¥–µ—Ç –≤ routeHubLayer –ø–æ–≤–µ—Ä—Ö –ª–∏–Ω–∏–∏
    if (routeSet && routeSet.has(h.id)) continue;

    const mk = L.marker([h.lat, h.lng], {
      icon: makeHubIcon(h, isHubActive(h)),
      pane: "hubPane"
    }).bindTooltip(
      `${escapeHtml(h.name_ru || "–•–∞–±")}${isHubActive(h) ? " ‚Ä¢ –∞–∫—Ç–∏–≤–Ω—ã–π" : ""}`,
      { direction:"top", offset:[0,-10] }
    );

    hubLayer.addLayer(mk);
  }
}

/* ================= MARKERS ================= */
function buildPopup(car) {
  const title = `${car.brand || ""} ${car.model || ""}`.trim() || "–ê–≤—Ç–æ–º–æ–±–∏–ª—å";
  return `
    <b>${escapeHtml(title)}</b><br/>
    <span style="font-size:12px;color:#666">–°—Ç–∞—Ç—É—Å: ${escapeHtml(car.status || "‚Äî")}</span>
  `;
}

function upsertMarkers() {
  const ids = new Set(cars.map(c => c.id));
  for (const [id, mk] of markersByCarId.entries()) {
    if (!ids.has(id)) {
      cluster.removeLayer(mk);
      markersByCarId.delete(id);
    }
  }

  for (const car of cars) {
    if (!car.pos || typeof car.pos.lat !== "number" || typeof car.pos.lng !== "number") continue;

    const isSel = car.id === selectedCarId;
    let marker = markersByCarId.get(car.id);

    if (!marker) {
      marker = L.marker([car.pos.lat, car.pos.lng], {
        icon: makeCarIcon(isSel),
        pane: "carPane"
      });
      marker.bindPopup(buildPopup(car));
      marker.on("click", () => selectCarById(car.id));
      markersByCarId.set(car.id, marker);
      cluster.addLayer(marker);
    } else {
      marker.setLatLng([car.pos.lat, car.pos.lng]);
      marker.setIcon(makeCarIcon(isSel));
      marker.setPopupContent(buildPopup(car));
    }
  }
}

/* ================= DATA ================= */
async function loadData() {
  const resp = await fetch(WORKER_PUBLIC_URL + `?t=${Date.now()}`, { cache:"no-store" });
  const data = await resp.json();

  hubs = (data.hubs || []);
  hubsById = new Map(hubs.map(h => [h.id, h]));

  cars = (data.cars || []).filter(c => c.pos && typeof c.pos.lat === "number");

  // –±–∞–∑–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä (–±–µ–∑ –º–∞—Ä—à—Ä—É—Ç–∞)
  /
