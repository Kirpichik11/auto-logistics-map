<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Логистика авто</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display: grid; grid-template-columns: 1fr 360px; height: 100vh; }
    #map { height: 100vh; }
    .side { border-left: 1px solid #eee; padding: 12px; overflow: auto; }
    .title { font-size: 16px; font-weight: 700; margin: 0 0 8px; }
    .sub { font-size: 12px; color: #666; margin: 0 0 12px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 10px; }
    .row { display: flex; gap: 10px; }
    .img { width: 88px; height: 66px; border-radius: 10px; background: #f3f3f3; object-fit: cover; }
    .meta { flex: 1; }
    .big { font-weight: 700; margin: 0; }
    .small { font-size: 12px; color: #666; margin: 4px 0 0; }
    .pill { display:inline-block; font-size: 12px; padding: 4px 8px; border-radius: 999px; background:#f6f6f6; margin-top:8px;}
    .muted { color:#777; }
    .hint { font-size: 12px; color: #777; margin-top: 8px; }
    .titem { display:flex; justify-content:space-between; gap:8px; font-size: 12px; padding: 6px 0; border-top: 1px dashed #eee; }
    .btn { display:inline-block; padding: 8px 10px; border-radius: 10px; border:1px solid #eee; background:#fff; cursor:pointer; }
    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; }
      .side { height: 40vh; }
      #map { height: 60vh; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="map"></div>
    <div class="side">
      <p class="title">Поставки автомобилей</p>
      <p class="sub">Позиции и статусы рассчитываются автоматически на сервере и обновляются регулярно.</p>

      <div class="card" id="summaryCard">
        <div><b id="countCars">—</b> авто на карте</div>
        <div class="hint">Кликните по машине на карте, чтобы увидеть информацию.</div>
      </div>

      <div id="details"></div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const WORKER_PUBLIC_URL = "/api/public";
const REFRESH_DATA_MS = 60_000;
const TICK_MS = 10_000;

// показывать ли хабы точками на карте
const SHOW_HUBS = true;

/** =========================
 * MAP SETUP
 * ========================= */
const map = L.map('map', { preferCanvas: true }).setView([50.5, 127.5], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18, attribution: '&copy; OpenStreetMap'
}).addTo(map);

const cluster = L.markerClusterGroup();
map.addLayer(cluster);

let cars = [];
let hubs = [];
let markersByCarId = new Map();
let hubLayer = L.layerGroup().addTo(map);

/** =========================
 * UTILS
 * ========================= */
function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, (m) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
  }[m]));
}

function fmtDate(iso) {
  if (!iso) return "—";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "—";
  return d.toLocaleString("ru-RU");
}

function fmtEta(isoArrive) {
  if (!isoArrive) return "—";
  const t = Date.parse(isoArrive);
  if (!t) return "—";
  const diff = t - Date.now();
  if (diff <= 0) return "сейчас";
  const hours = diff / 3600000;
  if (hours < 24) return `${Math.round(hours)} ч`;
  const days = hours / 24;
  if (days < 14) return `${days.toFixed(1)} дн`;
  return `${Math.round(days)} дн`;
}

function buildPopup(car) {
  const title = `${car.brand || ""} ${car.model || ""}`.trim() || "Автомобиль";
  const urgencyTxt = car.urgency === "fast" ? "Ускоренная" : "Стандарт";
  return `
    <b>${escapeHtml(title)}</b><br/>
    <span style="font-size:12px;color:#666">Статус: ${escapeHtml(car.status || "—")}</span><br/>
    <span style="font-size:12px;color:#666">Срочность: ${escapeHtml(urgencyTxt)}</span>
  `;
}

/** =========================
 * UI: details
 * ========================= */
function showCarDetails(car) {
  const el = document.getElementById("details");
  el.innerHTML = "";

  const card = document.createElement("div");
  card.className = "card";

  const imgHtml = car.photo_url ? `<img class="img" src="${car.photo_url}" alt="auto" />` : `<div class="img"></div>`;
  const title = `${car.brand || ""} ${car.model || ""}`.trim() || "Автомобиль";
  const urgencyTxt = car.urgency === "fast" ? "Ускоренная" : "Стандарт";

  card.innerHTML = `
    <div class="row">
      ${imgHtml}
      <div class="meta">
        <p class="big">${escapeHtml(title)}</p>
        <p class="small"><span class="muted">Срочность:</span> ${escapeHtml(urgencyTxt)}</p>
        <div class="pill">${escapeHtml(car.status || "—")}</div>
        <p class="small"><span class="muted">Ориентировочное прибытие:</span> ${escapeHtml(fmtDate(car.arrive_time))}</p>
        <p class="small"><span class="muted">Осталось:</span> ${escapeHtml(fmtEta(car.arrive_time))}</p>
      </div>
    </div>

    <div class="hint">Позиция обновляется автоматически.</div>
  `;
  el.appendChild(card);

  // приблизить к машине
  if (car.pos && typeof car.pos.lat === "number" && typeof car.pos.lng === "number") {
    map.setView([car.pos.lat, car.pos.lng], Math.max(map.getZoom(), 6), { animate: true });
  }
}

/** =========================
 * Hubs layer
 * ========================= */
function renderHubs() {
  hubLayer.clearLayers();
  if (!SHOW_HUBS) return;

  for (const h of hubs) {
    if (typeof h.lat !== "number" || typeof h.lng !== "number") continue;
    const mk = L.circleMarker([h.lat, h.lng], {
      radius: 5,
      weight: 1,
      fillOpacity: 0.6
    }).bindTooltip(`${escapeHtml(h.name_ru || "Хаб")}`, { direction: "top" });
    hubLayer.addLayer(mk);
  }
}

/** =========================
 * MARKERS
 * ========================= */
function upsertMarkers() {
  // remove old markers not present
  const carIds = new Set(cars.map(c => c.id));
  for (const [id, mk] of markersByCarId.entries()) {
    if (!carIds.has(id)) {
      cluster.removeLayer(mk);
      markersByCarId.delete(id);
    }
  }

  for (const car of cars) {
    if (!car.pos || typeof car.pos.lat !== "number" || typeof car.pos.lng !== "number") continue;

    let marker = markersByCarId.get(car.id);
    if (!marker) {
      marker = L.marker([car.pos.lat, car.pos.lng]);
      marker.on("click", () => showCarDetails(car));
      marker.bindPopup(buildPopup(car));
      markersByCarId.set(car.id, marker);
      cluster.addLayer(marker);
    } else {
      marker.setLatLng([car.pos.lat, car.pos.lng]);
      marker.setPopupContent(buildPopup(car));
    }
  }

  document.getElementById("countCars").textContent = String(cars.length);
}

/** =========================
 * DATA LOAD
 * ========================= */
async function loadData() {
  const resp = await fetch(WORKER_PUBLIC_URL, { cache: "no-store" });
  if (!resp.ok) throw new Error("Failed to load data");

  const data = await resp.json();

  hubs = (data.hubs || []).filter(h => typeof h.lat === "number" && typeof h.lng === "number");
  cars = (data.cars || []).filter(c => c.pos && typeof c.pos.lat === "number" && typeof c.pos.lng === "number");

  renderHubs();
  upsertMarkers();
}

async function start() {
  try {
    await loadData();
  } catch (e) {
    console.error(e);
    alert("Не удалось загрузить данные. Проверьте /api/public.");
    return;
  }

  setInterval(() => loadData().catch(console.error), REFRESH_DATA_MS);
  setInterval(() => upsertMarkers(), TICK_MS);
}

start();
</script>
</body>
</html>
