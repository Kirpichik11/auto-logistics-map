<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display: grid; grid-template-columns: 1fr 380px; height: 100vh; }
    #map { height: 100vh; }
    .side { border-left: 1px solid #eee; padding: 12px; overflow: auto; background:#fff; }
    .title { font-size: 16px; font-weight: 700; margin: 0 0 8px; }
    .sub { font-size: 12px; color: #666; margin: 0 0 12px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 10px; }
    .row { display: flex; gap: 10px; }
    .img { width: 88px; height: 66px; border-radius: 10px; background: #f3f3f3; object-fit: cover; }
    .meta { flex: 1; }
    .big { font-weight: 700; margin: 0; }
    .small { font-size: 12px; color: #666; margin: 4px 0 0; }
    .pill { display:inline-block; font-size: 12px; padding: 4px 8px; border-radius: 999px; background:#f6f6f6; margin-top:8px;}
    .muted { color:#777; }
    .hint { font-size: 12px; color: #777; margin-top: 8px; }

    /* List cards */
    .listCard { border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:10px; cursor:pointer; }
    .listCard:hover { background:#fafafa; }
    .listTop { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .listTitle { font-weight:700; font-size:13px; margin:0; }
    .badge { font-size:11px; padding:3px 8px; border-radius:999px; background:#f6f6f6; white-space:nowrap; }
    .bar { height:6px; background:#eee; border-radius:999px; overflow:hidden; margin-top:8px; }
    .bar > div { height:100%; width:0%; background:#111; border-radius:999px; }
    .listMeta { font-size:12px; color:#666; margin-top:6px; display:flex; justify-content:space-between; gap:10px; }
    .divider { border:none; border-top:1px dashed #eee; margin:12px 0; }

    /* Car icon */
    .carIcon {
      font-size: 18px;
      transform: translate(-6px, -10px);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
      user-select: none;
    }

    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; }
      .side { height: 45vh; }
      #map { height: 55vh; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="map"></div>

    <div class="side">
      <p class="title">–ü–æ—Å—Ç–∞–≤–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</p>
      <p class="sub">–ü–æ–∑–∏—Ü–∏–∏ –∏ —Å—Ç–∞—Ç—É—Å—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ.</p>

      <div class="card" id="summaryCard">
        <div><b id="countCars">‚Äî</b> –∞–≤—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
        <div class="hint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–≤—Ç–æ –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–µ.</div>
      </div>

      <div id="carList"></div>
      <hr class="divider" />
      <div id="details"></div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const WORKER_PUBLIC_URL = "/api/public";
const REFRESH_DATA_MS = 60_000;
const TICK_MS = 10_000;

/** =========================
 * MAP SETUP
 * ========================= */
const map = L.map('map', { preferCanvas: true }).setView([50.5, 127.5], 4);

/**
 * CARTO Positron (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ç–∞–π–ª—ã, –±–µ–∑ —Å–ø–æ—Ä–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤/—Ñ–ª–∞–≥–æ–≤)
 */
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19,
  attribution: ''
}).addTo(map);

const cluster = L.markerClusterGroup();
map.addLayer(cluster);

let cars = [];
let hubs = [];
let markersByCarId = new Map();

/** =========================
 * UTILS
 * ========================= */
function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, (m) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
  }[m]));
}

function fmtDate(iso) {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleString("ru-RU");
}

function fmtEta(isoArrive) {
  if (!isoArrive) return "‚Äî";
  const t = Date.parse(isoArrive);
  if (!t) return "‚Äî";
  const diff = t - Date.now();
  if (diff <= 0) return "—Å–µ–π—á–∞—Å";
  const hours = diff / 3600000;
  if (hours < 24) return `${Math.round(hours)} —á`;
  const days = hours / 24;
  if (days < 14) return `${days.toFixed(1)} –¥–Ω`;
  return `${Math.round(days)} –¥–Ω`;
}

function urgencyText(u) {
  return u === "fast" ? "–£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è" : "–°—Ç–∞–Ω–¥–∞—Ä—Ç";
}

/** =========================
 * Icons
 * ========================= */
function makeCarIcon(car) {
  const html = `<div class="carIcon">üöó</div>`;
  return L.divIcon({
    html,
    className: "",
    iconSize: [18, 18],
    iconAnchor: [9, 9]
  });
}

/** =========================
 * UI: details
 * ========================= */
function showCarDetails(car) {
  const el = document.getElementById("details");
  el.innerHTML = "";

  const card = document.createElement("div");
  card.className = "card";

  const imgHtml = car.photo_url ? `<img class="img" src="${car.photo_url}" alt="auto" />` : `<div class="img"></div>`;
  const title = `${car.brand || ""} ${car.model || ""}`.trim() || "–ê–≤—Ç–æ–º–æ–±–∏–ª—å";

  const pct = Math.round(((car.progress ?? 0) * 100));
  const eta = fmtEta(car.arrive_time);

  card.innerHTML = `
    <div class="row">
      ${imgHtml}
      <div class="meta">
        <p class="big">${escapeHtml(title)}</p>
        <p class="small"><span class="muted">–°—Ä–æ—á–Ω–æ—Å—Ç—å:</span> ${escapeHtml(urgencyText(car.urgency))}</p>
        <div class="pill">${escapeHtml(car.status || "‚Äî")}</div>

        <div class="bar" style="margin-top:10px"><div style="width:${pct}%"></div></div>
        <p class="small"><span class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å:</span> ${pct}%</p>

        <p class="small"><span class="muted">–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ–µ –ø—Ä–∏–±—ã—Ç–∏–µ:</span> ${escapeHtml(fmtDate(car.arrive_time))}</p>
        <p class="small"><span class="muted">–û—Å—Ç–∞–ª–æ—Å—å:</span> ${escapeHtml(eta)}</p>
      </div>
    </div>

    <div class="hint">–ü–æ–∑–∏—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
  `;
  el.appendChild(card);

  // —Ñ–æ–∫—É—Å –∫ –º–∞—à–∏–Ω–µ
  if (car.pos && typeof car.pos.lat === "number" && typeof car.pos.lng === "number") {
    map.setView([car.pos.lat, car.pos.lng], Math.max(map.getZoom(), 6), { animate: true });
  }
}

/** =========================
 * List
 * ========================= */
function renderCarList() {
  const el = document.getElementById("carList");
  if (!el) return;

  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –±–ª–∏–∂–µ –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –≤—ã—à–µ
  const list = [...cars].sort((a,b) => (b.progress ?? 0) - (a.progress ?? 0));

  el.innerHTML = list.map(car => {
    const title = `${car.brand || ""} ${car.model || ""}`.trim() || "–ê–≤—Ç–æ–º–æ–±–∏–ª—å";
    const pct = Math.round((car.progress ?? 0) * 100);
    const eta = fmtEta(car.arrive_time);
    const badge = urgencyText(car.urgency);

    return `
      <div class="listCard" data-id="${car.id}">
        <div class="listTop">
          <p class="listTitle">${escapeHtml(title)}</p>
          <span class="badge">${escapeHtml(badge)}</span>
        </div>

        <div class="bar"><div style="width:${pct}%"></div></div>

        <div class="listMeta">
          <span>${escapeHtml(car.status || "‚Äî")}</span>
          <span>ETA: ${escapeHtml(eta)}</span>
        </div>
      </div>
    `;
  }).join("");

  for (const node of el.querySelectorAll(".listCard")) {
    node.addEventListener("click", () => {
      const id = node.getAttribute("data-id");
      const car = cars.find(x => x.id === id);
      if (!car) return;
      showCarDetails(car);

      // –æ—Ç–∫—Ä—ã—Ç—å popup –Ω–∞ –∫–∞—Ä—Ç–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä)
      const mk = markersByCarId.get(id);
      if (mk) mk.openPopup();
    });
  }
}

/** =========================
 * MARKERS
 * ========================= */
function buildPopup(car) {
  const title = `${car.brand || ""} ${car.model || ""}`.trim() || "–ê–≤—Ç–æ–º–æ–±–∏–ª—å";
  return `
    <b>${escapeHtml(title)}</b><br/>
    <span style="font-size:12px;color:#666">–°—Ç–∞—Ç—É—Å: ${escapeHtml(car.status || "‚Äî")}</span>
  `;
}

function upsertMarkers() {
  // remove old markers not present
  const carIds = new Set(cars.map(c => c.id));
  for (const [id, mk] of markersByCarId.entries()) {
    if (!carIds.has(id)) {
      cluster.removeLayer(mk);
      markersByCarId.delete(id);
    }
  }

  for (const car of cars) {
    if (!car.pos || typeof car.pos.lat !== "number" || typeof car.pos.lng !== "number") continue;

    let marker = markersByCarId.get(car.id);
    if (!marker) {
      marker = L.marker([car.pos.lat, car.pos.lng], { icon: makeCarIcon(car) });
      marker.on("click", () => showCarDetails(car));
      marker.bindPopup(buildPopup(car));
      markersByCarId.set(car.id, marker);
      cluster.addLayer(marker);
    } else {
      marker.setLatLng([car.pos.lat, car.pos.lng]);
      marker.setPopupContent(buildPopup(car));
      // –µ—Å–ª–∏ —Å—Ä–æ—á–Ω–æ—Å—Ç—å –ø–æ–º–µ–Ω—è–µ—Ç—Å—è ‚Äî –æ–±–Ω–æ–≤–∏–º –∏–∫–æ–Ω–∫—É
      marker.setIcon(makeCarIcon(car));
    }
  }

  document.getElementById("countCars").textContent = String(cars.length);
}

/** =========================
 * DATA LOAD
 * ========================= */
async function loadData() {
  const resp = await fetch(WORKER_PUBLIC_URL, { cache: "no-store" });
  if (!resp.ok) throw new Error("Failed to load data");
  const data = await resp.json();

  hubs = (data.hubs || []);
  cars = (data.cars || []).filter(c =>
    c.pos && typeof c.pos.lat === "number" && typeof c.pos.lng === "number"
  );

  // –µ—Å–ª–∏ progress –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç (–ø–æ–∫–∞ –Ω–µ —Å–¥–µ–ª–∞–ª–∏ –ø–∞—Ç—á API), –ø—É—Å—Ç—å –±—É–¥–µ—Ç 0
  for (const c of cars) {
    if (typeof c.progress !== "number") c.progress = 0;
  }

  upsertMarkers();
  renderCarList();
}

async function start() {
  try {
    await loadData();
  } catch (e) {
    console.error(e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ /api/public.");
    return;
  }

  setInterval(() => loadData().catch(console.error), REFRESH_DATA_MS);
  setInterval(() => {
    // –±–µ–∑ –ø–µ—Ä–µ—Å—á—ë—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–æ—Ç—Ä–∏—Å—É–µ–º, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
    upsertMarkers();
  }, TICK_MS);
}

start();
</script>
</body>
</html>
